<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.62.2" />
    <meta name="description" content="Do Learn">
<meta name="author" content="Myeongjin Kim">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
    <title>Ansible Playbooks :: Ibiza</title>

    
    <link href="/css/nucleus.css?1582894342" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1582894342" rel="stylesheet">
    <link href="/css/hybrid.css?1582894342" rel="stylesheet">
    <link href="/css/featherlight.min.css?1582894342" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1582894342" rel="stylesheet">
    <link href="/css/auto-complete.css?1582894342" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1582894342" rel="stylesheet">
    <link href="/css/theme.css?1582894342" rel="stylesheet">
    <link href="/css/hugo-theme.css?1582894342" rel="stylesheet">
    
      <link href="/css/theme-mine.css?1582894342" rel="stylesheet">
    

    <script src="/js/jquery-3.3.1.min.js?1582894342"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/ansible/ansible-for-devops/ansible-playbooks/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <div>
<img src="https://avatars3.githubusercontent.com/u/6358016?s=460&v=4" style="border-radius: 50%"  width="50%" height="50%"/>
</div>
<p style="color: white">Ibiza</p>
<p style="color: white">꾸준하게, 오랫동안, 열심히</p>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1582894342"></script>
<script type="text/javascript" src="/js/auto-complete.js?1582894342"></script>
<script type="text/javascript">
    
        var baseurl = "http:\/\/kimmj.github.io\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1582894342"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/ibiza/" title="Ibiza" class="dd-item 
        
        
        
        ">
      <a href="/ibiza/">
          <i class='fas fa-angle-right'></i>&nbsp;Ibiza
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/ibiza/importance-of-record/" title="Importance of Record" class="dd-item ">
        <a href="/ibiza/importance-of-record/">
        <i class='fas fa-minus'></i>&nbsp;Importance of Record
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ibiza/2020-plan/" title="2020 Plan" class="dd-item ">
        <a href="/ibiza/2020-plan/">
        <i class='fas fa-minus'></i>&nbsp;2020 Plan
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ibiza/ibiza-project/" title="Ibiza Project" class="dd-item ">
        <a href="/ibiza/ibiza-project/">
        <i class='fas fa-minus'></i>&nbsp;Ibiza Project
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ibiza/2020-new-year-holiday-plans/" title="2020 New Year Holiday Plans" class="dd-item ">
        <a href="/ibiza/2020-new-year-holiday-plans/">
        <i class='fas fa-minus'></i>&nbsp;2020 New Year Holiday Plans
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/git/" title="Git" class="dd-item 
        
        
        
        ">
      <a href="/git/">
          <i class='fas fa-angle-right'></i>&nbsp;Git
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/git/gitignore/" title="Gitignore 설정" class="dd-item ">
        <a href="/git/gitignore/">
        <i class='fas fa-minus'></i>&nbsp;Gitignore 설정
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/python/" title="Python" class="dd-item 
        
        
        
        ">
      <a href="/python/">
          <i class='fas fa-angle-right'></i>&nbsp;Python
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/python/python-beautiful-cli/" title="[번역]Python을 통해 이쁜 CLI 만들기" class="dd-item ">
        <a href="/python/python-beautiful-cli/">
        <i class='fas fa-minus'></i>&nbsp;[번역]Python을 통해 이쁜 CLI 만들기
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/docker/" title="Docker" class="dd-item 
        
        
        
        ">
      <a href="/docker/">
          <i class='fas fa-angle-right'></i>&nbsp;Docker
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/docker/connect-container-to-container/" title="[docker-compose] container에서 다른 container로 접속하기" class="dd-item ">
        <a href="/docker/connect-container-to-container/">
        <i class='fas fa-minus'></i>&nbsp;[docker-compose] container에서 다른 container로 접속하기
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/jenkins/" title="Jenkins" class="dd-item 
        
        
        
        ">
      <a href="/jenkins/">
          <i class='fas fa-angle-right'></i>&nbsp;Jenkins
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/jenkins/install/" title="Jenkins Install" class="dd-item ">
        <a href="/jenkins/install/">
        <i class='fas fa-minus'></i>&nbsp;Install
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/iac/" title="IaC" class="dd-item 
        
        
        
        ">
      <a href="/iac/">
          <i class='fas fa-angle-right'></i>&nbsp;IaC
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/iac/translate-what-is-infrastructure-as-a-code/" title="[번역] What Is Infrastructure as a Code? How It Works, Best Practices, Tutorials" class="dd-item ">
        <a href="/iac/translate-what-is-infrastructure-as-a-code/">
        <i class='fas fa-minus'></i>&nbsp;[Translate] What Is Infrastructure as a Code
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/cicd/" title="CICD" class="dd-item 
        
        
        
        ">
      <a href="/cicd/">
          <i class='fas fa-angle-right'></i>&nbsp;CICD
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/cicd/deploy-strategy/" title="Deploy Strategy" class="dd-item ">
        <a href="/cicd/deploy-strategy/">
        <i class='fas fa-minus'></i>&nbsp;Deploy Strategy
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/css/" title="CSS" class="dd-item 
        
        
        
        ">
      <a href="/css/">
          <i class='fas fa-angle-right'></i>&nbsp;CSS
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/css/greater-than-sign/" title="Greater Than Sign" class="dd-item ">
        <a href="/css/greater-than-sign/">
        <i class='fas fa-minus'></i>&nbsp;Greater Than Sign
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/prometheus/" title="Prometheus" class="dd-item 
        
        
        
        ">
      <a href="/prometheus/">
          <i class='fas fa-angle-right'></i>&nbsp;Prometheus
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/prometheus/install/" title="Install Prometheus" class="dd-item ">
        <a href="/prometheus/install/">
        <i class='fas fa-minus'></i>&nbsp;Install
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/prometheus/federation/" title="Federation" class="dd-item ">
        <a href="/prometheus/federation/">
        <i class='fas fa-minus'></i>&nbsp;Federation
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/kubernetes/" title="Kubernetes" class="dd-item 
        
        
        
        ">
      <a href="/kubernetes/">
          <i class='fas fa-angle-right'></i>&nbsp;Kubernetes
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/kubernetes/installation/" title="Install" class="dd-item 
        
        
        
        ">
      <a href="/kubernetes/installation/">
          <i class='fas fa-angle-right'></i>&nbsp;Install
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/kubernetes/installation/overview/" title="Overview" class="dd-item ">
        <a href="/kubernetes/installation/overview/">
        <i class='fas fa-minus'></i>&nbsp;Overview
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/kubernetes/installation/install-kubeadm/" title="Install Kubeadm" class="dd-item ">
        <a href="/kubernetes/installation/install-kubeadm/">
        <i class='fas fa-minus'></i>&nbsp;Install Kubeadm
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/kubernetes/installation/create-a-single-control-plane-cluster-with-kubeadm/" title="Create a Single Control Plane Cluster With Kubeadm" class="dd-item ">
        <a href="/kubernetes/installation/create-a-single-control-plane-cluster-with-kubeadm/">
        <i class='fas fa-minus'></i>&nbsp;Create a Single Control Plane Cluster With Kubeadm
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/kubernetes/concepts/" title="Concepts" class="dd-item 
        
        
        
        ">
      <a href="/kubernetes/concepts/">
          <i class='fas fa-angle-right'></i>&nbsp;Concepts
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/kubernetes/concepts/controllers-overview/" title="Controllers Overview" class="dd-item ">
        <a href="/kubernetes/concepts/controllers-overview/">
        <i class='fas fa-minus'></i>&nbsp;Controllers Overview
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/kubernetes/concepts/pods/" title="Pods" class="dd-item ">
        <a href="/kubernetes/concepts/pods/">
        <i class='fas fa-minus'></i>&nbsp;Pods
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/kubernetes/stern/" title="Stern을 이용하여 여러 pod의 log를 한번에 확인하기" class="dd-item ">
        <a href="/kubernetes/stern/">
        <i class='fas fa-minus'></i>&nbsp;Stern을 이용하여 여러 pod의 log를 한번에 확인하기
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/hugo/" title="Hugo" class="dd-item 
        
        
        
        ">
      <a href="/hugo/">
          <i class='fas fa-angle-right'></i>&nbsp;Hugo
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/hugo/ibiza/" title="Ibiza" class="dd-item 
        
        
        
        ">
      <a href="/hugo/ibiza/">
          <i class='fas fa-angle-right'></i>&nbsp;Ibiza
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/hugo/ibiza/font-change/" title="Font Change" class="dd-item ">
        <a href="/hugo/ibiza/font-change/">
        <i class='fas fa-minus'></i>&nbsp;Font Change
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/hugo/insert-comment/" title="Hugo에 Comment 추가하기 (Utterance)" class="dd-item ">
        <a href="/hugo/insert-comment/">
        <i class='fas fa-minus'></i>&nbsp;Hugo에 Comment 추가하기 (Utterance)
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/hugo/hugo-with-html/" title="HUGO로 HTML이 되지 않을 때 가능하게 하는 방법" class="dd-item ">
        <a href="/hugo/hugo-with-html/">
        <i class='fas fa-minus'></i>&nbsp;hugo with html
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/spinnaker/" title="Spinnaker" class="dd-item 
        
        
        
        ">
      <a href="/spinnaker/">
          <i class='fas fa-angle-right'></i>&nbsp;Spinnaker
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/spinnaker/installation/" title="Installation" class="dd-item 
        
        
        
        ">
      <a href="/spinnaker/installation/">
          <i class='fas fa-angle-right'></i>&nbsp;Installation
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/spinnaker/installation/overview/" title="Overview" class="dd-item ">
        <a href="/spinnaker/installation/overview/">
        <i class='fas fa-minus'></i>&nbsp;Overview
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/spinnaker/installation/install-halyard/" title="Install Halyard" class="dd-item ">
        <a href="/spinnaker/installation/install-halyard/">
        <i class='fas fa-minus'></i>&nbsp;Install Halyard
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/spinnaker/installation/choose-cloud-providers/" title="Choose Cloud Providers" class="dd-item ">
        <a href="/spinnaker/installation/choose-cloud-providers/">
        <i class='fas fa-minus'></i>&nbsp;Choose Cloud Providers
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/spinnaker/installation/choose-your-environment/" title="Choose Your Environment" class="dd-item ">
        <a href="/spinnaker/installation/choose-your-environment/">
        <i class='fas fa-minus'></i>&nbsp;Choose Your Environment
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/spinnaker/installation/choose-a-storage-service/" title="Choose a Storage Service" class="dd-item ">
        <a href="/spinnaker/installation/choose-a-storage-service/">
        <i class='fas fa-minus'></i>&nbsp;Choose a Storage Service
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/spinnaker/installation/deploy-and-connect/" title="Deploy and Connect" class="dd-item ">
        <a href="/spinnaker/installation/deploy-and-connect/">
        <i class='fas fa-minus'></i>&nbsp;Deploy and Connect
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/spinnaker/installation/install-in-air-gaped-environment/" title="Install in Air Gaped Environment" class="dd-item ">
        <a href="/spinnaker/installation/install-in-air-gaped-environment/">
        <i class='fas fa-minus'></i>&nbsp;Install in Air Gaped Environment
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/spinnaker/canaryanalysis/" title="CanaryAnalysis" class="dd-item 
        
        
        
        ">
      <a href="/spinnaker/canaryanalysis/">
          <i class='fas fa-angle-right'></i>&nbsp;CanaryAnalysis
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/spinnaker/canaryanalysis/canary-analysis/" title="Canary Analysis" class="dd-item ">
        <a href="/spinnaker/canaryanalysis/canary-analysis/">
        <i class='fas fa-minus'></i>&nbsp;Canary Analysis
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/spinnaker/tips/" title="Tips" class="dd-item 
        
        
        
        ">
      <a href="/spinnaker/tips/">
          <i class='fas fa-angle-right'></i>&nbsp;Tips
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/spinnaker/tips/pipeline-expressions/" title="Pipeline Expressions" class="dd-item ">
        <a href="/spinnaker/tips/pipeline-expressions/">
        <i class='fas fa-minus'></i>&nbsp;Pipeline Expressions
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/ansible/" title="Ansible" class="dd-item 
        parent
        
        
        ">
      <a href="/ansible/">
          <i class='fas fa-angle-right'></i>&nbsp;Ansible
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/ansible/ansible-for-devops/" title="Ansible for DevOps" class="dd-item 
        parent
        
        
        ">
      <a href="/ansible/ansible-for-devops/">
          <i class='fas fa-angle-right'></i>&nbsp;Ansible for DevOps
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/ansible/ansible-for-devops/getting-started-with-ansible/" title="Chapter 1 - Getting Started With Ansible" class="dd-item ">
        <a href="/ansible/ansible-for-devops/getting-started-with-ansible/">
        <i class='fas fa-minus'></i>&nbsp;Getting Started With Ansible
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ansible/ansible-for-devops/local-infrastructure-development-ansible-and-vagrant/" title="Chapter 2 - Local Infrastructure Development: Ansible and Vagrant" class="dd-item ">
        <a href="/ansible/ansible-for-devops/local-infrastructure-development-ansible-and-vagrant/">
        <i class='fas fa-minus'></i>&nbsp;Local Infrastructure Development: Ansible and Vagrant
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ansible/ansible-for-devops/ad-hoc-commands/" title="Ad Hoc Commands" class="dd-item ">
        <a href="/ansible/ansible-for-devops/ad-hoc-commands/">
        <i class='fas fa-minus'></i>&nbsp;Ad Hoc Commands
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible/ansible-for-devops/chapter5/" title="Chapter5" class="dd-item 
        
        
        
        ">
      <a href="/ansible/ansible-for-devops/chapter5/">
          <i class='fas fa-angle-right'></i>&nbsp;Chapter5
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/ansible/ansible-for-devops/chapter5/ansible-playbooks-beyond-the-basics/" title="Ansible Playbooks Beyond the Basics" class="dd-item ">
        <a href="/ansible/ansible-for-devops/chapter5/ansible-playbooks-beyond-the-basics/">
        <i class='fas fa-minus'></i>&nbsp;Ansible Playbooks Beyond the Basics
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ansible/ansible-for-devops/ansible-playbooks/" title="Ansible Playbooks" class="dd-item active">
        <a href="/ansible/ansible-for-devops/ansible-playbooks/">
        <i class='fas fa-minus'></i>&nbsp;Ansible Playbooks
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ansible/create-vm-with-ansible-libvirt/" title="Create Vm With Ansible Libvirt" class="dd-item ">
        <a href="/ansible/create-vm-with-ansible-libvirt/">
        <i class='fas fa-minus'></i>&nbsp;Create Vm With Ansible Libvirt
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/ubuntu/" title="Ubuntu" class="dd-item 
        
        
        
        ">
      <a href="/ubuntu/">
          <i class='fas fa-angle-right'></i>&nbsp;Ubuntu
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/ubuntu/tools/" title="Tools" class="dd-item 
        
        
        
        ">
      <a href="/ubuntu/tools/">
          <i class='fas fa-angle-right'></i>&nbsp;Tools
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/ubuntu/tools/tmux/" title="Tmux" class="dd-item ">
        <a href="/ubuntu/tools/tmux/">
        <i class='fas fa-minus'></i>&nbsp;Tmux
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ubuntu/network/" title="Network" class="dd-item 
        
        
        
        ">
      <a href="/ubuntu/network/">
          <i class='fas fa-angle-right'></i>&nbsp;Network
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/ubuntu/network/netplan/" title="Netplan으로 static IP 할당받기" class="dd-item ">
        <a href="/ubuntu/network/netplan/">
        <i class='fas fa-minus'></i>&nbsp;Netplan으로 static IP 할당받기
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ubuntu/base64-encode-decode/" title="Ubuntu에서 Base64로 인코딩, 디코딩하기" class="dd-item ">
        <a href="/ubuntu/base64-encode-decode/">
        <i class='fas fa-minus'></i>&nbsp;Ubuntu에서 Base64로 인코딩, 디코딩하기
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ubuntu/file-edit-without-editor/" title="Editor(vi)가 없을 때 파일 수정하기" class="dd-item ">
        <a href="/ubuntu/file-edit-without-editor/">
        <i class='fas fa-minus'></i>&nbsp;Editor(vi)가 없을 때 파일 수정하기
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ubuntu/check-listen-port/" title="열려있는 포트 확인하기" class="dd-item ">
        <a href="/ubuntu/check-listen-port/">
        <i class='fas fa-minus'></i>&nbsp;열려있는 포트 확인하기
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ubuntu/using-watch-with-pipes/" title="pipe를 사용한 명령어를 watch로 확인하기" class="dd-item ">
        <a href="/ubuntu/using-watch-with-pipes/">
        <i class='fas fa-minus'></i>&nbsp;pipe를 사용한 명령어를 watch로 확인하기
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ubuntu/use-alias-in-watch/" title="watch를 사용할 때 alias 이용하기" class="dd-item ">
        <a href="/ubuntu/use-alias-in-watch/">
        <i class='fas fa-minus'></i>&nbsp;watch를 사용할 때 alias 이용하기
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ubuntu/ssh-without-password/" title="password 없이 ssh 접속하기" class="dd-item ">
        <a href="/ubuntu/ssh-without-password/">
        <i class='fas fa-minus'></i>&nbsp;password 없이 ssh 접속하기
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ubuntu/ssh-tunneling/" title="SSH Tunneling 사용법" class="dd-item ">
        <a href="/ubuntu/ssh-tunneling/">
        <i class='fas fa-minus'></i>&nbsp;SSH Tunneling 사용법
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ubuntu/ssh-with-jump/" title="Gateway를 이용하여 SSH 접속하기" class="dd-item ">
        <a href="/ubuntu/ssh-with-jump/">
        <i class='fas fa-minus'></i>&nbsp;Gateway를 이용하여 SSH 접속하기
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ubuntu/change-hostname/" title="Hostname 변경하기" class="dd-item ">
        <a href="/ubuntu/change-hostname/">
        <i class='fas fa-minus'></i>&nbsp;Hostname 변경하기
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ubuntu/unattended-ubuntu/" title="추가 입력절차(prompt) 없이 Ubuntu 설치하는 이미지 만들기" class="dd-item ">
        <a href="/ubuntu/unattended-ubuntu/">
        <i class='fas fa-minus'></i>&nbsp;추가 입력절차(prompt) 없이 Ubuntu 설치하는 이미지 만들기
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ubuntu/how-to-edit-boot-parameter-during-install/" title="Ubuntu 설치 시 Boot Parameter를 수정하기" class="dd-item ">
        <a href="/ubuntu/how-to-edit-boot-parameter-during-install/">
        <i class='fas fa-minus'></i>&nbsp;Ubuntu 설치 시 Boot Parameter를 수정하기
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/ubuntu/how-to-use-sudo-without-password/" title="sudo를 password 없이 사용하기" class="dd-item ">
        <a href="/ubuntu/how-to-use-sudo-without-password/">
        <i class='fas fa-minus'></i>&nbsp;sudo를 password 없이 사용하기
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/english/" title="English" class="dd-item 
        
        
        
        ">
      <a href="/english/">
          <i class='fas fa-angle-right'></i>&nbsp;English
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/english/himym/" title="HIMWM" class="dd-item 
        
        
        
        ">
      <a href="/english/himym/">
          <i class='fas fa-angle-right'></i>&nbsp;HIMWM
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/english/himym/season1/" title="Season1" class="dd-item 
        
        
        
        ">
      <a href="/english/himym/season1/">
          <i class='fas fa-angle-right'></i>&nbsp;Season1
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode1/" title="Episode1" class="dd-item ">
        <a href="/english/himym/season1/episode1/">
        <i class='fas fa-minus'></i>&nbsp;Episode1
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode5/" title="Episode5" class="dd-item ">
        <a href="/english/himym/season1/episode5/">
        <i class='fas fa-minus'></i>&nbsp;Episode5
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode6/" title="Episode6" class="dd-item ">
        <a href="/english/himym/season1/episode6/">
        <i class='fas fa-minus'></i>&nbsp;Episode6
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode7/" title="Episode7" class="dd-item ">
        <a href="/english/himym/season1/episode7/">
        <i class='fas fa-minus'></i>&nbsp;Episode7
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode8/" title="Episode8" class="dd-item ">
        <a href="/english/himym/season1/episode8/">
        <i class='fas fa-minus'></i>&nbsp;Episode8
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode9/" title="Episode9" class="dd-item ">
        <a href="/english/himym/season1/episode9/">
        <i class='fas fa-minus'></i>&nbsp;Episode9
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode10/" title="Episode10" class="dd-item ">
        <a href="/english/himym/season1/episode10/">
        <i class='fas fa-minus'></i>&nbsp;Episode10
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode11/" title="Episode11" class="dd-item ">
        <a href="/english/himym/season1/episode11/">
        <i class='fas fa-minus'></i>&nbsp;Episode11
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode12/" title="Episode12" class="dd-item ">
        <a href="/english/himym/season1/episode12/">
        <i class='fas fa-minus'></i>&nbsp;Episode12
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode13/" title="Episode13" class="dd-item ">
        <a href="/english/himym/season1/episode13/">
        <i class='fas fa-minus'></i>&nbsp;Episode13
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode14/" title="Episode14" class="dd-item ">
        <a href="/english/himym/season1/episode14/">
        <i class='fas fa-minus'></i>&nbsp;Episode14
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode15/" title="Episode15" class="dd-item ">
        <a href="/english/himym/season1/episode15/">
        <i class='fas fa-minus'></i>&nbsp;Episode15
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode16/" title="Episode16" class="dd-item ">
        <a href="/english/himym/season1/episode16/">
        <i class='fas fa-minus'></i>&nbsp;Episode16
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode17/" title="Episode17" class="dd-item ">
        <a href="/english/himym/season1/episode17/">
        <i class='fas fa-minus'></i>&nbsp;Episode17
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode18/" title="Episode18" class="dd-item ">
        <a href="/english/himym/season1/episode18/">
        <i class='fas fa-minus'></i>&nbsp;Episode18
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode19/" title="Episode19" class="dd-item ">
        <a href="/english/himym/season1/episode19/">
        <i class='fas fa-minus'></i>&nbsp;Episode19
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode20/" title="Episode20" class="dd-item ">
        <a href="/english/himym/season1/episode20/">
        <i class='fas fa-minus'></i>&nbsp;Episode20
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode21/" title="Episode21" class="dd-item ">
        <a href="/english/himym/season1/episode21/">
        <i class='fas fa-minus'></i>&nbsp;Episode21
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season1/episode22/" title="Episode22" class="dd-item ">
        <a href="/english/himym/season1/episode22/">
        <i class='fas fa-minus'></i>&nbsp;Episode22
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/english/himym/season2/" title="Season2" class="dd-item 
        
        
        
        ">
      <a href="/english/himym/season2/">
          <i class='fas fa-angle-right'></i>&nbsp;Season2
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season2/episode01/" title="Episode01" class="dd-item ">
        <a href="/english/himym/season2/episode01/">
        <i class='fas fa-minus'></i>&nbsp;Episode01
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/english/himym/season2/episode03/" title="Episode03" class="dd-item ">
        <a href="/english/himym/season2/episode03/">
        <i class='fas fa-minus'></i>&nbsp;Episode03
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://github.com/KimMJ"><i class='fab fa-github'></i> Github</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://gohugo.io/"><i class='fas fa-bookmark'></i> Hugo Documentation</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://learn.netlify.com/en/"><i class='fas fa-bookmark'></i> Hugo Theme Learn</a>
              </li>
          
              <li> 
                  <a class="padding" href="http://kimmj.github.io/tags"><i class='fas fa-tags'></i> Tags</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Ibiza</a> > <a href='/ansible/'>Ansible</a> > <a href='/ansible/ansible-for-devops/'>Ansible for DevOps</a> > Ansible Playbooks
          
         
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#power-plays">Power plays</a></li>
    <li><a href="#running-playbooks-with-ansible-playbook">Running Playbooks with ansible-playbook</a>
      <ul>
        <li><a href="#limiting-playbooks-to-particular-hosts-and-groups">Limiting playbooks to particular hosts and groups</a></li>
        <li><a href="#setting-user-and-sudo-options-with-ansible-playbook">Setting user and sudo options with ansible-playbook</a></li>
        <li><a href="#other-options-for-ansible-playbook">Other options for ansible-playbook</a></li>
      </ul>
    </li>
    <li><a href="#real-world-playbook-centos-nodejs-app-server">Real-world playbook: CentOS Node.js app server</a>
      <ul>
        <li><a href="#add-extra-repositories">Add extra repositories</a></li>
        <li><a href="#deploy-a-nodejs-app">Deploy a Node.js app</a></li>
        <li><a href="#launch-a-nodejs-app">Launch a Node.js app</a></li>
        <li><a href="#nodejs-app-server-summary">Node.js app server summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
<div class="tags">

  <a class="tag-link" href="/tags/ansible">ansible</a>

  <a class="tag-link" href="/tags/ansible-playbooks">ansible-playbooks</a>

</div>

        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Ansible Playbooks
            </h1>
          

        



<nav id="TableOfContents">
  <ul>
    <li><a href="#power-plays">Power plays</a></li>
    <li><a href="#running-playbooks-with-ansible-playbook">Running Playbooks with ansible-playbook</a>
      <ul>
        <li><a href="#limiting-playbooks-to-particular-hosts-and-groups">Limiting playbooks to particular hosts and groups</a></li>
        <li><a href="#setting-user-and-sudo-options-with-ansible-playbook">Setting user and sudo options with ansible-playbook</a></li>
        <li><a href="#other-options-for-ansible-playbook">Other options for ansible-playbook</a></li>
      </ul>
    </li>
    <li><a href="#real-world-playbook-centos-nodejs-app-server">Real-world playbook: CentOS Node.js app server</a>
      <ul>
        <li><a href="#add-extra-repositories">Add extra repositories</a></li>
        <li><a href="#deploy-a-nodejs-app">Deploy a Node.js app</a></li>
        <li><a href="#launch-a-nodejs-app">Launch a Node.js app</a></li>
        <li><a href="#nodejs-app-server-summary">Node.js app server summary</a></li>
      </ul>
    </li>
  </ul>
</nav>

<h2 id="power-plays">Power plays</h2>
<p>다른 여느 configuration management solution처럼 <code>Ansible</code>은 configuration file을 설명하는데 메타포를 사용한다.
이를 <code>playbooks</code>라고 부르고 여기에는 특정한 서버나 특정 서버 그룹에서 실행되는 tasks(<code>Ansible</code>의 용어에서는 <code>play</code>)의 리스트가 있다.
미식 축구에서 팀은 게임에서 이기기 위해 사전 정의된 playbook을 플레이의 기반으로 실행하고 따른다.
<code>Ansible</code>에서 우리는 <code>playbook</code>(서버가 특정한 configuration state로 가기 위해 실행해야 하는 스텝들의 리스트)을 작성하고 서버 위에서 <code>play</code>되도록 할 것이다.</p>
<p><code>Playbook</code>은 configuration을 정의하는 상황에서는 자주 쓰이고 사람이 읽을 수 있는 간단한 문법을 가진 <code>YAML</code>로 작성되어있다.
<code>Playbook</code>은 다른 <code>playbook</code>에 포함될 수 있고 특정 metadata와 옵션들은 다른 play를 하도록 할 수 있으며 또는 <code>playbook</code>이 서버마다 다른 시나리오로 동작하게 할 수도 있다.</p>
<p><code>ad-hoc</code> 명령어는 그 자체로 <code>Ansible</code>을 powerful하게 만들어준다.
<code>playbook</code>은 <code>Ansible</code>을 최고의 server provisioning과 configuration management tool로 만들어준다.</p>
<p>대부분의 DevOps 사람들이 <code>Ansible</code>에 매료된 이유는 shell scripts를 쉽게 직접 ansible play로 변경할 수 있기 때문이다.
다음의 스크립트가 있다고 가정해보자.
이는 RHEL/CentOS 서버에 Apache를 설치하는 것이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Install Apache</span>
yum install --quiet -y httpd httpd-devel
<span style="color:#75715e"># Copy configuration files</span>
cp /path/to/config/httpd.conf /etc/httpd/conf/httpd.conf
cp /path/to/config/httpd-vhosts.conf /etc/httpd/conf/httpd-vhosts.conf
<span style="color:#75715e"># Start Apache and configure it to run at boot</span>
service httpd start
chkconfig httpd on
</code></pre></div><p>shell script를 실행하려면(이 경우에 파일 이름은 <code>shell-script.sh</code>이다), command line에서 직접 호출하면 된다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># (From the same directory in which the shell script resides)</span>
$ ./shell-script.sh
</code></pre></div><p><strong>Ansible Playboook</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
- hosts: all
  tasks:
  - name: Install Apache.
    command: yum install --quiet -y httpd httpd-devel
  - name: Copy configuration files.
    command: <span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">     </span><span style="color:#e6db74"> </span><span style="color:#e6db74">cp /path/to/config/httpd.conf /etc/httpd/conf/httpd.conf</span>
  - command: <span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">     </span><span style="color:#e6db74"> </span><span style="color:#e6db74">cp /path/to/config/httpd-vhosts.conf /etc/httpd/conf/httpd-vhosts.conf</span>
  - name: Start Apache and configure it to run at boot.
    command: service httpd start
  - command: chkconfig httpd on
</code></pre></div><p><code>Ansible</code> Playbook을 실행하려면(이 경우 파일 이름은 <code>playbook.yml</code>이다), <code>ansible-playbook</code> 명령어로 호출할 수 있다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># (From the same sirectory in which the playbook resides)</span>
$ ansible-playbook playbook.yml
</code></pre></div><p><code>Ansible</code>은 표준 shell command를 작성할 수 있고(수 십년간 사용해왔던 명령어들) 시간만 있다면 playbook을 사용하도록 빠르게 바꿀 수 있고 <code>Ansible</code>의 유용한 기능의 장점을 사용하여 configuration을 rebuild할 수 있어 강력한 툴이다.</p>
<p>위의 playbook에서 <code>Ansible</code>의 <code>command</code> module을 사용하여 standard shell commands를 실행시켰다.
또한 우리는 각 play에 <code>name</code>을 부여하여 playbook을 실행했을 때 play가 사람이 읽을 수 있는 결과를 스크린 또는 로그에 띄울 수 있도록 한다.
command module은 다른 트릭들을 가지고 있지만 지금 우리는 shell script가 <code>Ansible</code> playbook으로 귀찮은 작업 없이 바로 변환이 가능하고 확신한다.</p>

<div class="notices note" ><p><code>&gt;</code>는 <code>command:</code> module 바로 뒤에 와서 YAML이 &ldquo;자동으로 다음의 indented line을 하나의 긴 string으로 줄바꿈은 스페이스로 분리하며 변환&quot;하도록 해준다.
이는 어떤 케이스에선 readability를 향상시키는데 도움을 준다.
유효한 YAML 문법을 통해 configuration을 설명하는 방법에는 많은 것들이 있고 이런 방법들은 나중에 Appendix B - YAML Conventions and Best Practices 섹션에서 깊게 다루어 볼 것이다.<br>
이 책은 세가지 task-formatting 테크딕들을 살펴볼 것이다.
하나 또는 두개의 간단한 parameter가 있는 task는 <code>Ansible</code>의 shorthand syntax가 사용될 것이다(예: <code>yum: name=apache2 state=installed</code>).
더 긴 command 입력이 필요한 <code>command</code>나 <code>shell</code>의 대부분의 경우에는 위에서 언급한 <code>&gt;</code> 테크닉을 사용할 것이다.
여러 parameter가 필요한 task들은 YAML object notation이 사용된다.
이는 각 줄의 key와 variable을 대치할때 사용된다.</p>
</div>

<p>위의 playbook이 정확히 shell script와 같은 동작을 하지만 이를 <code>Ansible</code>의 built-in modules로 어려운 일을 해결할 수 있다.</p>
<p><strong>Revised Ansible Playbook - Now with idempotence!</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
- hosts: all
  sudo: yes
  tasks:
  - name: Install Apache.
    yum: name={{ item }} state=present
    with_items:
    - httpd
    - httpd-devel
  - name: Copy configuration files.
    copy:
      src: <span style="color:#e6db74">&#34;{{ item.src }}&#34;</span>
      dest: <span style="color:#e6db74">&#34;{{ item.dest }}&#34;</span>
      owner: root
      group: root
      mode: <span style="color:#ae81ff">0644</span>
    with_items:
    - {
        src: <span style="color:#e6db74">&#34;/path/to/config/httpd.conf&#34;</span>,
        dest: <span style="color:#e6db74">&#34;/etc/httpd/conf/httpd.conf&#34;</span>
    }
    - {
        src: <span style="color:#e6db74">&#34;/path/to/config/httpd-vhosts.conf&#34;</span>,
        dest: <span style="color:#e6db74">&#34;/etc/httpd/conf/httpd-vhosts.conf&#34;</span>
    }
  - name: Make sure Apache is started and configure it to run at boot.
    service: name=httpd state=started enabled=yes
</code></pre></div><p>이제 뭔가 되어가고 있다.
이제 이 playbook을 차근차근 밟아보자.</p>
<ol>
<li>처음에 <code>---</code>는 이 문서를 YAML syntax를 가지고 사용했다고 표시한 것이다.
마치 HTML의 맨 위에 <code>&lt;html&gt;</code>을 쓰는것 또는 PHP code block 제일 위에 <code>&lt;?php</code>를 넣는것과 같다.</li>
<li>둘째 줄의 <code>- hosts: all</code>은 첫(이 경우는 유일하게) <code>play</code>를 정의한 것이고 <code>Ansible</code>이 알고있는 <code>all</code> hosts에서 play를 실행하도록 한다.</li>
<li>셋째 줄에서 <code>sudo: yes</code>는 <code>Ansible</code>이 모든 명령어를 <code>sudo</code>를 통해 실행하도록 하고 따라서 모든 명령어는 root 유저로 실행될 것이다.</li>
<li>네번째 줄에서 <code>tasks:</code>는 <code>Ansible</code>이 다음의 task 목록들을 이 playbook의 일부로 실행하도록 하는 것이다.</li>
<li>첫번째 task는 <code>name: Install Apache...</code>로 시작하고 name은 서버에서 어떤 동작을 하는 module은 아니다.
그냥 사람이 읽을 수 있는 description을 제공한다.
<code>Install Apache</code>를 보는 것은 <code>yum name=httpd state=installed</code>를 보는 것보다 상대적으로 더 연관성이 있어 보인다.
그러나 name 줄을 완전히 지워버버려 아무 문제도 발생하지 않는다.
<ul>
<li><code>yum</code> module을 사용하여 Apache를 설치하였다.
<code>yum -y install httpd httpd-devel</code>을 사용하는 것 대신 <code>Ansible</code>에게 정확히 우리가 원하는 상태가 뭔지 알려주었다.
<code>Ansible</code>은 <code>items</code> 배열에서 우리가 넣은 값들을 가져올 것이다.
(<code>{{ variable }}</code>는 <code>Ansible</code> playbook의 variable을 참조한다)
우리는 <code>yum</code>이 <code>state=present</code>를 통해 우리가 정의한 패키지가 설치되어있다고 확신할 수 있지만 <code>state=latest</code>로 하면 최신 버전이 깔려있도록 할 수도 있고 <code>state=absent</code>를 하면 패키지가 설치되지 않은 상태가 되도록 할 수도 있다.</li>
<li><code>Ansible</code>은 <code>with_items</code>를 이용하여 간단한 리스트를 tasks에 주입할 수 있다.
item의 list를 하단에 정의하면 각 라인은 play에 하나씩 전달될 것이다.
이 경우에 각 아이템은 <code>{{ item }}</code> variable로 대체되었다.</li>
</ul>
</li>
<li>두번째 task는 다시 사람이 읽을 수 있는 name을 설정하는 것으로 시작한다.
(원한다면 지울 수 있다.)
<ul>
<li>우리는 <code>copy</code> module을 사용하여 파일을 source(우리의 local workstation)에서 destination(관리중인 서버)로 복사할 것이다.
소유권과 권한(<code>owner</code>, <code>group</code>, <code>mode</code>)을 포함한 file metadata같은 더 많은 variable들을 전달할 수도 있다.</li>
<li>이 경우 변수 치환을 위해 multiple elements를 사용한 배열을 쓸 것이다.
이 때 <code>{ var1: value, var2: value }</code> 문법을 사용하여 각 variable에 대한 element를 정의할 수 있다.
(원하는 만큼 variable을 정의할 수 있고 또는 nested level로 variable을 정의할 수 있다.)
play에서 variable을 언급하면 item의 variable에는 <code>.</code>을 통해 접근할 수 있고 따라서 <code>{{ item.var1 }}</code>을 통해 첫번째 variable에 접근할 수 있다.
우리의 예시에서 <code>item.src</code>는 각 item의 src에 접근하는 것이다.</li>
</ul>
</li>
<li>세번째 task는 사람이 읽을 수 있는 포멧으로 정의된 이름을 사용한다.
<ul>
<li>우리는 <code>service</code> module을 사용하여 특정 service의 원하는 상태를 기술할 것이다.
이 경우에는 Apache의 http daemon인 <code>httpd</code>이다.
우리는 이것이 실행중이길 원하고 따라서 <code>state=started</code>로 설정하였고 또 시스템이 시작되었을 때 실행되길 원하기 때문에 <code>enabled=yes</code>로 설정하였다.
(<code>chkconfig httpd on</code>과 동일하다.)</li>
</ul>
</li>
</ol>
<p>명령어의 리스트를 변환한 것의 가장 좋은 점은 <code>Ansible</code>이 계속해서 모든 우리의 서버의 상태를 추적한다는 것이다.
playbook을 처음 실행하면 이는 Apache가 설치되었고 동작되었는지 확인하고, custom configuration이 제위치에 있는지 확인하여 서버를 provision한다.</p>
<p>더 좋은 점은 <strong>두번째</strong> 실행했을 때 서버가 제대로 된 상태에 있다면 실제로 아무것도 하지도 않고 우리에게 아무것도 변경된 것이 없다고 말해준다.
따라서 이 짧은 playbook을 통해, 우리는 provision할 수 있고 Apache web server에 대해 적절한 configuration이 되었음을 확인할 수 있다.
게다가 playbook을 <code>--check</code> 옵션으로 실행하면(아래의 다음 섹션에서 확인할 수 있다) configuration이 우리가 playbook에서 정의한 것과 일치하는지를 서버에서 실제 task를 돌리지 않고도 검증할 수 있다.</p>
<p>configuration을 업데이트하고 싶거나 다른 httpd 패키지를 설치하고 싶으면 file을 local에서 수정하거나 패키지를 <code>with_items</code> 리스트안에 넣고 다시 playbook을 실행하면 된다.
하나든 수천개의 서버든지 그 configuration은 우리의 playbook에 맞게 업데이트될 것이다.
그리고 <code>Ansible</code>은 우리에게 어떤 것이 변하였는지 알려줄 것이다.
(각각의 production server에 ah-hoc change를 만들지는 않았을 것이다. 그렇지 않은가?)</p>
<h2 id="running-playbooks-with-ansible-playbook">Running Playbooks with <code>ansible-playbook</code></h2>
<p>위의 예시로 playbook을 실행한다면(<code>all</code> hosts로 실행하게 되어있다), playbook은 <code>Ansible</code> inventory file에 정의된 모든 host에 대해 실행될 것이다(챕터 1의 basic inventory file 예시를 확인해보아라).</p>
<h3 id="limiting-playbooks-to-particular-hosts-and-groups">Limiting playbooks to particular hosts and groups</h3>
<p><code>hosts:</code>를 바꿔서 playbook이 특정한 그룹이나 각각의 hosts에만 동작할 수 있도록 설정할 수 있다.
해당 값은 <code>all</code> hosts, inventory에 정의된 <code>group</code>, 여러 group들 (e.g. <code>webservers, dbservers</code>, 개별 서버(e.g. <code>at1.example.com</code>, 혼합된 host들로 설정할 수 있다.
또한 <code>*.example.com</code>과 같은 wildcard를 사용하여 최상위 도메인 중 매칭되는 모든 도메인으로 설정할 수 있다.</p>
<p>또한 <code>ansible-playbook</code> 명령어를 통해 playbook이 실행될 hosts를 제한할 수 있다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ansible-playbook playbook.yml --limit webservers
</code></pre></div><p>이 경우(inventory file이 <code>webserver</code> group을 포함한다고 가정한다), playbook이 <code>hosts: all</code>로 설정되어 있거나 <code>webservers</code> group외의 hosts들을 포함한다고 하더라도 <code>webservers</code>에 정의된 hosts에서만 동작한다.</p>
<p>또한 playbook을 특정 hosts에만 동작하게 할 수 있다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ansible-playbook playbook.yml --limit xyz.example.com
</code></pre></div><p>실행시키기 전에 playbook에 의해 영향을 받는 hosts들이 실제 어떤것인지 확인하고 싶으면 <code>--list-hosts</code>를 사용하면 된다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ansible-playbook playbook.yml --list-hosts
</code></pre></div><p>결과는 다음과 같을 것이다.</p>
<pre><code class="language-plain-text" data-lang="plain-text">playbook: playbook.yml

  play #1 (all): host count=4
    127.0.0.1
    192.168.24.2
    foo.example.com
    bar.example.com
</code></pre><p>(<code>count</code>는 inventory에 정의된 서버의 숫자이고 그 아래는 inventory에 정의된 모든 hosts의 리스트이다.)</p>
<h3 id="setting-user-and-sudo-options-with-ansible-playbook">Setting user and sudo options with <code>ansible-playbook</code></h3>
<p>playbook의 <code>hosts</code> 안에 어떤 <code>user</code>도 정의되어 있지 않으면 <code>Ansible</code>은 특정 host에 대해 inventory file에서 정의한 user로 접속한다고 가정하며, 그 다음 local user account name으로 변경할 것이다.
<code>--remote-user (-u)</code> 옵션을 통해서 원격 play에 사용될 remote user를 명시적으로 정의할 수 있다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ansible-playbook playbook.yml --remote-user<span style="color:#f92672">=</span>johndoe
</code></pre></div><p>어떤 상황에서는 원격 서버에서 <code>sudo</code>를 통해 명령어를 수행하기 위해 sudo password를 입력해야할 필요가 있을 것이다.
이런 상황에서는 <code>--ask-sudo-pass (-K)</code> 옵션이 필요할 것이다.
또한 <code>--sudo</code>를 사용하여 명시적으로 playbook 안의 모든 tasks를 강제로 sudo 권한으로 실행하게 할 수 있다.
마지막으로 <code>--sudo-user (-U)</code>옵션을 통해 <code>sudo</code>로 tasks를 실행할 sudo user(default는 root)를 지정할 수 있다.</p>
<p>예를 들어, 다음의 명령어는 playbook을 sudo로 실행할 것이고, task에서 <code>janedoe</code>라는 sudo user를 쓸 것이고, <code>Ansible</code>은 sudo password를 입력하게 할 것이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ansible-playbook playbook.yml --sudo --sudo-user<span style="color:#f92672">=</span>janedoe --ask-sudo-pass
</code></pre></div><p>key-based 인증방식을 사용하여 서버에 접속하지 않는다면(챕터 1에서 그렇게 했을 때 security implication에 대한 경고사항을 읽어라), <code>--ask-pass</code>를 사용할 수 있다.</p>
<h3 id="other-options-for-ansible-playbook">Other options for <code>ansible-playbook</code></h3>
<p><code>ansible-playbook</code> 명령어는 다른 옵션들도 사용할 수 있다.</p>
<ul>
<li><code>--inventory=PATH (-i PATH)</code>: custom inventory file을 정의한다.
(default는 default Ansible inventory file이고 보통은 <code>/etc/ansible/hosts</code>에 위치해 있다.)</li>
<li><code>--verbose (-v)</code>는 Verbose mode이다.
(성공한 옵션들에 대한 output을 토함한 모든 output을 보여준다.)
<code>-vvvv</code>를 통해 매 분마다 자세하게 볼 수 있다.</li>
<li><code>--extra-vars=VARS (-e VARS)</code>: playbook에서 사용되는 variables를 <code>&quot;key=value, key=value&quot;</code>의 형태로 정의할 수 있다.</li>
<li><code>--forks=NUM (-f NUM)</code>: fork하는 수이다(integer).
이 값을 5보다 크게하여 <code>Ansible</code>이 task를 동시에 실행하는 서버의 수를 늘릴 수 있다.</li>
<li><code>--connection=TYPE (-c TYPE)</code>: 사용할 connection의 type이다.
(default는 <code>ssh</code>이다.
가끔은 <code>local</code>로 playbook을 local machine에서 실행할 수 있고 또는 cron을 통해 원격 서버에서 실행할 수 있다.)</li>
<li><code>--check</code>: playbook을 Check Mode (&ldquo;Dry Run&rdquo;)으로 실행한다.
playbook안에 정의된 모든 task는 모든 hosts에 대해 확인될 것이지만 실제로 실행하지는 않는다.</li>
</ul>
<p><code>ansible-playbook</code>을 최대한 활용하기 위해서 중요한 다른 옵션과 configuration variable이 있다.
그러나 여기 목록들로도 지금 챕터에서 우리의 서버와 가상 머신에 playbook을 실행하는데 충분한 것들이다.</p>

<div class="notices notes" ><p>이 챕터의 나머지는 더 현실적인 <code>Ansible</code> playbook을 사용할 것이다.
이 챕터의 모든 예시는 <a href="">Ansible for DevOps GitHub repository</a>에 있고, 이를 clone하여 컴퓨터에 저장하고(또는 online으로 코드를 띄워서) 뒤의 단계를 더 쉽게 할 수 있다.</p>
</div>

<h2 id="real-world-playbook-centos-nodejs-app-server">Real-world playbook: CentOS Node.js app server</h2>
<p>물론 여전히 옛날 Apache 서버에서 static web page를 포스트하려는 사람에게는 유용할지 모르겠지만, 첫번째 예시는 real-world 시나리오에 적합하지는 않다.
실제로 오늘날 production infrastructure를 관리하는 데 사용되는 것과 관련된 더 많은 것들을 할 수 있는, 좀 더 복잡한 playbook을 실행할 것이다.</p>
<p>첫번째 playbook은 CentOS를 Node.js를 이용하여 설정할 것이다.
그리고나서 간단한 Node.js application을 설치하고 실행할 것이다.
서버는 매우 간단한 architecture로 되어있다.</p>
<pre><code class="language-ascii" data-lang="ascii">+-------------------------------------------------+
|                                                 |
|               Node.js Server/VM                 |
|                                                 |
+-------------------------------------------------+
|                                                 |
|  +-------------------------------------------+  |
|  |                                           |  |
|  |        Custom Node.js application         |  |
|  |                                           |  |
|  +-------------------------------------------+  |
|                                                 |
|  +-------------------------------------------+  |
|  |                                           |  |
|  |              Node.js + NPM                |  |
|  |                                           |  |
|  +-------------------------------------------+  |
|                                                 |
|  +-------------------------------------------+  |
|  |                                           |  |
|  |            CeonOS 6.4 (Linux)             |  |
|  |                                           |  |
|  +-------------------------------------------+  |
|                                                 |
+-------------------------------------------------+

</code></pre><p>시작하기에 앞서 우리의 playbook을 포함하는 YAML 파일(이 예시에서는 <code>playbook</code>)을 생성해야 한다.
간단하게 가보자.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
- hosts: all
  tasks:
</code></pre></div><p>먼저 playbook이 동작하게 될 hosts들의 set(<code>all</code>)를 정의한다.
(playbook을 특정 groups와 hosts에 제한하는 섹션을 상단에서 확인하라.)
그리하여 뒤의 task들이 해당 hosts에서 실행할 것들이라고 정의한다.</p>
<h3 id="add-extra-repositories">Add extra repositories</h3>
<p>extra repositories(yum이나 apt)를 추가하는 것은 admin들이 서버에서 다른 작업을 하기 전에 특정한 패키지가 사용 가능한지 또는 base installation보다 최신 버전이 있는지 확인하는 작업이다.</p>
<p>아래의 shell script에서 우리는 EPEL과 Remi repositories를 추가하여 Node.js나 필수 소프트웨어의 최신 버전을 받고 싶다.
(이 예시는 RHEL/CentOS 6.x에서 동작한다고 가정한다)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Import EPEL GPG Key - see: https://fedoraproject.org/keys</span>
wget https://fedoraproject.org/static/0608B895.txt <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -O /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6

<span style="color:#75715e"># Import Remi GPG key - see: http://rpms.famillecollet.com/RPM-GPG-KEY-remi</span>
wget http://rpms.famillecollet.com/RPM-GPG-KEY-remi <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -O /etc/pki/rpm-gpg/RPM-GPG-KEY-rmi
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-remi

<span style="color:#75715e"># Install EPEL and Remi repos.</span>
rpm -Uvh --quiet <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
rpm -Uvh --quiet <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  http://rpms.famillecollet.com/enterprise/remi-release-6.rpm

<span style="color:#75715e"># Install Node.js (npm plus all its dependencies).</span>
yum --enablerepo<span style="color:#f92672">=</span>epel install node
</code></pre></div><p>이 shell script는 rpm command를 사용하여 EPEL과 Remi repository GPG keys를 import한다.
그러면 repositoriy들이 추가되고 마침내 Node.js가 설치된다.
이는 간단한 deployment에서는 잘 작동하지만 이미 이전에 실행했었다면(즉, 두개의 repository와 그것의 GPG key가 추가되었다면) 이 모든 명령어를 다 실행하는 것(어떤것은 시간이 걸릴수도 있고 연결이 연결이 잘 안된다면 모든 스크립트가 멈출수도 있다)은 어리석은 짓이다.</p>

<div class="notices note" ><p>몇가지 단계를 스킵하고싶으면 GPG key를 추가하는 것을 스킵할 수 있고 단순히 command를 <code>--nogpgcheck</code>(<code>Ansible</code>에서는 yum module의 <code>disabled_gpg_check</code> parameter를 <code>yes</code>로 설정한다)으로 실행하기만 하면 된다.
하지만 이를 활성화 하는 것이 좋은 생각이다.
GPG는 <code>GNU Privacy Guard</code>로, developer와 package distributor가 그들의 package에 서명하는 것이다.
(따라서 이 패키지가 원작자가 만든 것이며 수정이나 변경이 없었음을 확인해준다)
정말 우리가 뭘 하고있는지 알기 전까진 GPG key 체크같은 security setting을 disable하지 말아라.</p>
</div>

<p><code>Ansible</code>은 좀 더 튼튼하다.
좀 더 verbose할지 몰라도 더 정형화된 방법으로 같은 동작을 수행하며 이해하기 쉽고 나중에 설명할 <code>Ansible</code>의 다른 기능들과 variable을 사용할 수 있다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- name: Import EPEL and Remi GPG keys.
  rpm_key: <span style="color:#e6db74">&#34;key={{ item }} state=present&#34;</span>
  with_items:
  - <span style="color:#e6db74">&#34;https://fedoraproject.org/static/0608B895.txt&#34;</span>
  - <span style="color:#e6db74">&#34;http://rpms.famillecollect.com/RPM-GPG-KEY-remi&#34;</span>

- name: Install EPEL and Remi repos.
  command: <span style="color:#e6db74">&#34;rpm -Uvh --force {{ item.href }} creates={{ item.creates }}&#34;</span>
  with_items:
  - {
    href: <span style="color:#e6db74">&#34;http://download.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.prm&#34;</span>,
    creates: <span style="color:#e6db74">&#34;/etc/yum.repos.d/remi.repo&#34;</span>
  }

- name: Disable firewall (since this is a dev environment).
  service: name=iptables state=stopped enabled=no

- name: Install Node.js and npm.
  yum: name=npm state=present enablerepo=epel

- name: Install Forever (to run our Node.js app).
  npm: name=forever global=yes state-latest
</code></pre></div><p>한 단계씩 살펴보자.</p>
<ol>
<li><code>rpm_key</code>는 매우 간단한 <code>Ansible</code> module로 RPM key를 URL이나 file, 이미 존재하는 key의 key id로부터 가져온다.
그리고 key가 present이거나 absent(<code>state</code> parameter)가 되도록 한다.
우리는 Fedora project의 EPEL과 Remi Repository 두 key를 import하고 싶다.</li>
<li><code>Ansible</code>이 built-in rpm module을 가지고 있지 않기 때문에 우리는 rpm 명령어를 사용할 것이다.
하지만 <code>Ansible</code>의 <code>command</code> module을 사용하여 우리는 두가지를 얻을 수 있다.
<ol>
<li><code>creates</code> pamameter로 <code>Ansible</code> 명령어를 실행하지 않을 때를 알려준다.
(이 경우 <code>Ansible</code>에게 <code>rpm</code> command가 성공하면 어떤 파일이 존재하게 되는지 알려준다)</li>
<li>multidimensional array를 사용하여(<code>with_items</code>) URL을 정의하고 <code>creates</code>로 결과 파일을 체크한다.</li>
</ol>
</li>
<li>Node.js가 없으면 <code>yum</code>은 Node.js를 설치(Node의 package manager인 <code>npm</code>도 함께)한다.
그리고 EPEL repo가 <code>enablerepo</code> parameter를 통해 검색될 수 있도록 한다.
(<code>disablerepo</code>를 통해 명시적으로 repository를 <code>disable</code>할 수도 있다)</li>
<li>NPM이 설치되었기 때문에 <code>Ansible</code>의 <code>npm</code> module로 Node.js utility를 설치할 것이고 <code>forever</code>로 우리의 app을 실행하고 계속 동작하도록 할 것이다.
<code>global</code>을 <code>yes</code>로 설정하면 NPM은 <code>forever</code> node moulde을 <code>/usr/lib/node_modules/</code>에 설치할 것이고 따라서 모든 user가 Node.js app을 시스템에서 사용할 수 있을 것이다.</li>
</ol>
<p>이제 Node.js app server 셋업의 시작점에 와있다.
이제 간단한 Node.js app을 셋업하여 80포트에서 HTTP request를 받아보자.</p>
<h3 id="deploy-a-nodejs-app">Deploy a Node.js app</h3>
<p>다음 단계는 간단한 Node.js app을 우리의 서버에 설치하는 것이다.
먼저, <code>playbook.yml</code>이 위치한 폴더에 새 폴더 <code>app</code>을 생성하고 정말 간단한 Node.js app을 생성할 것이다.
폴더 안에서 새 파일 <code>app.js</code>를 생성하고 다음의 내용을 입력한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// Load the express module
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">express</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;express&#39;</span>),
<span style="color:#a6e22e">app</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">express</span>.<span style="color:#a6e22e">createServer</span>();

<span style="color:#75715e">// Respond to requests for / with &#39;Hello World&#39;.
</span><span style="color:#75715e"></span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>){
  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;Hello World!&#39;</span>);
});

<span style="color:#75715e">//Listen on port 80 (like a true web server).
</span><span style="color:#75715e"></span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#ae81ff">80</span>);
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;Express server started successfully.&#39;</span>);
</code></pre></div><p>문법이나 이것이 Node.js라는 것에 대해서는 걱정하지 말아라.
우리는 단지 빠르게 배포할 수 있는 예시가 필요한 것이다.
이 예시는 Python, Perl, Java, PHP 또는 다른 언어로 작성되지 않았다.
Node는 매우 간단한 언어(JavaScript)이기 때문에 간단하고 가벼운 환경에서 동작할 수 있고 서버를 테스트하거나 생성하는 데 사용하는 쉽고 좋은 언어이다.</p>
<p>이 작은 app이 Express(Node를 위한 http framework)에 의존성을 가지기 때문에, 우리는 NPM에게 <code>app.js</code>가 위치한 폴더와 같은 곳에 있는 <code>package.json</code>파일로 이 dependency에 대해 알려주어야 한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">{
  <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;examplenodeapp&#34;</span>,
  <span style="color:#e6db74">&#34;description&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Example Express Node.js app.&#34;</span>,
  <span style="color:#e6db74">&#34;author&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Jeff Geerling &lt;geerlingguy@mac.com&gt;&#34;</span>,
  <span style="color:#e6db74">&#34;dependencies&#34;</span><span style="color:#f92672">:</span> {
    <span style="color:#e6db74">&#34;expres&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;3.x.x&#34;</span>
  },
  <span style="color:#e6db74">&#34;engine&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;node &gt;= 0.10.6&#34;</span>
}
</code></pre></div><p>이제 다음을 playbook에 추가하고 전체 app을 서버에 복사한다.
그리고 NPM이 필요한 dependency들을 다운로드 받도록 한다(이 경우 <code>express</code>).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- name: Ensure Node.js app folder exists.
  file: <span style="color:#e6db74">&#34;path={{ node_apps_location }} state=directory&#34;</span>

- name: Copy example Node.js app to server.
  copy: <span style="color:#e6db74">&#34;src=app dest={{ node_apps_location }}&#34;</span>

- name: Install app dependencies defined in package.json.
  npm: path={{ node_apps_location }}/app
</code></pre></div><p>먼저, 우리는 <code>file</code> module을 통해 우리의 app이 설치될 곳에 디렉토리가 있는지 확인할 것이다.
각 command에 사용된 <code>{{ node_apps_location }}</code> variable은 playbook, inventory의 최상단의 <code>vars</code> section 또는 <code>ansible-playbook</code>으로 호출한 command line에서 정의할 수 있다.</p>
<p>두번째로 우리는 전체 app 폴더를 <code>Ansible</code>의 <code>copy</code> command를 사용하여 복사할 것이다.
이는 똑똑하게 단일 파일과 디렉토리를 구별하며 <code>scp</code>나 <code>rsync</code>처럼 디렉토리 내부를 돌며 동작한다.</p>

<div class="notices note" ><p><code>Ansible</code>의 <code>copy</code> module은 단일 또는 작은 그룹의 파일에 대해 잘 동작하고, 자동으로 디렉토리를 순회한다.
파일의 갯수가 수백개가 될 경우 또는 디렉토리 개위가 깊은 경우엔 <code>copy</code>는 교착상태에 빠질 것이다.
이러한 상황에서는 <code>synchronize</code> module로 전체 디렉토리를 복사할 수 있고 또는 <code>unarchive</code>로 archive를 복사하고 이를 서버에서 expand할 수 있다.</p>
</div>

<p>세번째로 app에 대한 path에 관한 추가적인 arguments 없이 <code>npm</code>을 다시 사용한다.
이는 NPM이 package.json 파일을 읽고 모든 dependency들이 존재하는지 확인하는 것이다.</p>
<p>이제 거의 다 끝이 났다!
마지막 단계는 app을 실행하는 것이다.</p>
<h3 id="launch-a-nodejs-app">Launch a Node.js app</h3>
<p>우리는 이제 (이전에 설치한)<code>forever</code>을 통해 app을 실행시킬 것이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- name: Check list of running Node.js apps.
  command: forever list
  register: forever_list
  changed_when: <span style="color:#66d9ef">false</span>
- name: Start example Node.js app.
  command: <span style="color:#e6db74">&#34;forever start {{ node_apps_location }}/app/app.js&#34;</span>
  when: <span style="color:#e6db74">&#34;forever_list.stdout.find(&#39;{{ node_apps_location }}/app/app.js&#39;) == -1&#34;</span>
</code></pre></div><p>첫 play에서 우리는 두가지 새로운 것을 한다.</p>
<ol>
<li><code>register</code>는 새로운 variable <code>forever_list</code>를 생성하여 다음 play에서 언제 play를 실행해야하는지 결정하는 용도로 사용한다.
<code>register</code>는 정의된 command에 variable name을 넣어서 output(stdout, stderr)를 보관한다.</li>
<li><code>changed_when</code>은 <code>Ansible</code>이 명시적으로 이 play가 서버에 변경사항을 줄 것이라고 말해준다.
이 경우 우리는 <code>forever list</code> command가 절대로 서버에 변경사항을 주지 않기 때문에 그냥 <code>false</code>를 설정한다.
이 경우 서버는 command가 실행될 때 전혀 변경되지 않을 것이다.</li>
</ol>
<p>두번째 play는 실제로 <code>forever</code>를 이용하여 app을 시작한다.
우리는 <code>node{{ node_apps_location }}/app/app.js</code>를 호출해서도 app을 시작할 수 있지만 프로세스를 쉽게 컨트롤할 수 없고 <code>Ansible</code>이 이 play에 hanging이 되는것을 막기 위해서는 <code>nohup</code>이나 <code>&amp;</code>을 써야한다.</p>
<p><code>forever</code>는 자신이 관리하는 Node app을 추적하고 우리는 <code>forever</code>의 <code>list</code> 옵션을 사용하여 동작중인 app의 리스트를 확인할 수 있다.
처음 이 playbook을 실행하면 list는 비어있을 것이다.
하지만 나중에 실행했을 때에는 app이 실행중이라면 우리는 이 app의 다른 인스턴스를 생성하고 싶지는 않다.
이런 상황을 피하려면 우리는 <code>Ansible</code>에게 언제 우리가 app을 시작하고 싶어하는지를 <code>when</code>을 통해 알려주면 된다.
특히 우리는 <code>Ansible</code>에게 app의 path가 <code>forever list</code> output에 없을 때에만 실행하라고 했다.</p>
<h3 id="nodejs-app-server-summary">Node.js app server summary</h3>
<p>여기서 우리는 80 port로 오는 HTTP request에 대해 &ldquo;Hello World!&ldquo;를 출력하는 간단한 Node.js app을 설치하는 playbook을 완성하였다.</p>
<p>이 playbook을 server에서 동작하게 하려면(우리의 경우 Vagrant 또는 수동으로 새로운 VM을 테스트용도로 생성하면 된다) 다음의 명령어를 사용한다(<code>node_apps_location</code> variable을 command를 통해 넘겨라)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ansible-playbook playbook.yml --extra-vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;node_apps_location=/usr/local/opt/node&#34;</span>
</code></pre></div><p>우리의 playbook이 서버를 configuring하고 app을 대포하는 것을 마쳤다면 브라우저를 통해(<code>curl</code>, <code>wget</code>을 사용해도 된다) <code>http://hostname/</code>에 접속해보아라.
다음과 같은 결과를 볼 수 있다.</p>
<p>간단하지만 매우 강력하다.
우리는 50줄도 안되는 YAML로 Node.js application server 전체를 configure했다.</p>

<div class="notices notes" ><p>전체 Node.js app server playbook은 이 책의 code repository인 <a href="https://github.com/geerlingguy/ansible-for-devops">https://github.com/geerlingguy/ansible-for-devops</a>의 <code>nodejs</code> 디렉토리에서 확인할 수 있다.</p>
<h2 id="real-world-playbook-ubuntu-lamp-server-with-drupal">Real-world playbook: Ubuntu LAMP server with Drupal</h2>
<p>이젠 Ansible <code>playbook</code>과 그것을 정의하는 YAML 문법에 친숙해져야 한다.
여기서 대부분의 예시는 CentOS, RHEL, Fedora 서버를 사용한다고 가정한다.
Ansible은 다른 Linux나 BSD같은 시스템에서도 잘 동작한다.
다음의 예시에서 Drupal website를 실행하기 위해 우리는 전통적인 LAMP(Linux, Apache, MySQL, PHP)를 Ubuntu 12.04에 셋업할 것이다.</p>
<pre><code class="language-chart" data-lang="chart">+-----------------------------------------------------------+
|                                                           |
|                  Drupal LAMP Server / VM                  |
|                                                           |
+-----------------------------------------------------------+
|                                                           |
| +-------------------------------------------------------+ |
| |                                                       | |
| |                                                       | |
| |                 Drupal (application)                  | |
| |                                                       | |
| |                                                       | |
| +-------------------------------------------------------+ |
|                                                           |
| +--------------------------+ +--------------------------+ |
| |                          | |                          | |
| |       PHP 5.4.x          | |                          | |
| |                          | |        Mysql 5.6.x       | |
| |       Apache 2.2.x       | |                          | |
| |                          | |                          | |
| +--------------------------+ +--------------------------+ |
|                                                           |
| +-------------------------------------------------------+ |
| |                                                       | |
| |                      Ubuntu 12.04                     | |
| |                                                       | |
| |                        (Linux)                        | |
| |                                                       | |
| +-------------------------------------------------------+ |
|                                                           |
+-----------------------------------------------------------+
</code></pre><h2 id="include-a-variables-file-and-discover-pre_tasks-and-handlers">Include a variables file, and discover <code>pre_tasks</code> and <code>handlers</code></h2>
<p>이 playbook에서 우리는 좀 더 playbook을 효과적으로 구성하는 것부터 시작할 것이다.
command line을 통해 전달해주어야 할 필수 variable들을 정의하는 대신, 분리된 <code>vars.yml</code>파일에서 Ansible이 사용할 variables를 따로 관리하여 playbook을 실행하도록 하자.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- hosts: all

  vars_files:
  - vars.yml
</code></pre></div><p>하나 이상의 variable file을 가지면 main playbook file을 깨끗하게 해줄 것이고 모든 configurable variable을 한곳에 정리할 수 있다.
이 때, 우리는 어떤 variable도 추가하지 않아도 된다.
우리는 <code>vars.yml</code>을 나중에 정의할 것이다.
지금은 빈 파일을 생성하고 playbook의 다음 section인 <code>pre_task</code>를 진행해보자.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  pre_tasks:
  - name: Update apt cache if needed.
    apt: update_cache=yes cache_valid_time=<span style="color:#ae81ff">3600</span>
</code></pre></div><p>Ansible은 main으로 실행할 task들이 실행되기 전과 이후에 <code>pre_tasks</code>와 <code>post_tasks</code>로 특정한 task를 실행할 수 있다.
이 경우에 우리는 playbook의 나머지가 실행되기 전에 apt cache가 업데이트 되어 우리의 서버에서 최신 버전의 패키지가 깔려있는지 확인을 하고 싶다.
우리는 Ansible의 <code>apt</code> module을 사용하여 지난 update 이후 3600초(1시간)보다 오래 경과했을 경우 cache를 업데이트 하라고 지시한다.</p>
<p>그런식으로 한 다음에 우리는 <code>handlers:</code>라는 새로운 section을 추가할 것이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  handlers:
  - name: restart apache
    service: name=apache2 state=restarted
</code></pre></div><p><code>handlers</code>는 그 그룹의 어느 task에서든지 <code>notify</code> 옵션을 추가하여 task 그룹 가장 마지막에 실행되는 특별한 종류의 task이다.
handler는 task들 중 하나가 handler에게 server에 변경사항을 만들 것(그리고 실패하지 않았음)이란걸 알릴 때만 호출되고 task 그룹의 가장 마지막에만 알림을 받는다.</p>
<p>이 hanlder를 호출하려면 <code>notify: restart apache</code> 옵션을 나머지 play에서 정의하면 된다.
우리는 이 handler를 정의하여 아래에 설명하듯 <code>apache2</code> service를 configuration이 변경되고 나서 재시작할 수 있도록 한다.</p>
<div class="notices notes" ><p>variables처럼 handler와 task는 별도의 파일에 존재할 수 있고 playbook 안에서 이를 자그마하게 할 수 있다.
(이에 대해서는 챕터 6에서 다루어 볼 것이다.)
하지만 간결하게 하기 위해 이 챕터에서의 예시들은 하나의 playbook file에 모두 보여진다.
우리는 다른 playbook organization 방법에 대해 나중에 토론해 볼 것이다.</p>
</div>
<h3 id="basic-lamp-server-setup">Basic LAMP server setup</h3>
<p>LAMP stack에 의존성을 가지는 application server를 구축하는 첫 단계는 실제 LAMP 쪽을 빌드하는 것이다.
이는 간단한 프로세스이지만 개별 서버에서 추가적인 약간의 작업이 필요하다.
Apache, MySQL, PHP를 설치하고 싶지만 우리는 또한 다른 dependency도 필요하고 또한 extra apt repository에서만 사용할 수 있는 PHP의 특정 버전(5.5) 버전이 필요하다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  tasks:
  - name: Get Software for apt repository management.
    apt: name={{ item }} state=installed
    with_items:
    - python-apt
    - python-pycurl
  - name: add ondrej repository for later versions of PHP.
    apt_repository: repo=<span style="color:#e6db74">&#39;ppa:ondrej/php5&#39;</span> update_cache=yes

  - name: <span style="color:#e6db74">&#34;Install Apache, MySQL, PHP, and other dependencies.&#34;</span>
    apt: name={{ item }} state=installed
    with_items:
    - git
    - curl
    - sendmail
    - apache2
    - php5
    - php5-common
    - php5-mysql
    - php5-cli
    - php5-curl
    - php5-gd
    - php5-dev
    - php5-mcrypt
    - php-apc
    - php-pear
    - python-mysqldb
    - mysql-server
  - name: Disable the firewall (since this is for local dev only).
    service: name=ufw state=stopped

  - name: <span style="color:#e6db74">&#34;Start Apache, MySQL, and PHP.&#34;</span>
    service: <span style="color:#e6db74">&#34;name={{ item }} state=started enabled=yes&#34;</span>
    with_items:
    - apache2
    - mysql
</code></pre></div><p>이 playbook에서 우리는 각각 이름지어진 play에 간단한 prefix를 추가하기로 경정하였고 따라서 playbook의 progress가 실행될 때 더 쉽게 따라갈 수 있게 되었다.
일반적인 LAMP setup으로 시작할 것이다.</p>
<ol>
<li>두개의 helper library를 설치할 것이다.
이것들은 python이 apt을 더 정확하게 관리할 수 있도록 한다.
(<code>python-apt</code>, <code>python-pycurl</code>은 <code>apt-repository</code> module이 동작하는 데 필요하다)</li>
<li>Ubuntu 12.04의 default apt repository가 PHP 5.4.x(또는 이후 버전)를 포함하지 않기 때문에 PHP 5.4.25(이글을 작성하는 시점에서)과 나머지 PHP package들을 포함하는 ondrej의 <code>PHP5-oldstable</code> repository를 설치한다.</li>
<li>우리의 LAMP server에 필요한 모든 package를 설치한다(Drupal을 실행하기 위한 php5 extension들도 설치한다).</li>
<li>테스트 목적을 위해 firewall을 모두 disable한다.
production server나 어떤 server가 인터넷에 노출되어 있으면 22, 80, 443 또는 필요한 port만 허용하는 엄격한 firewall을 사용해야 한다.</li>
<li>모든 필요한 service를 시작하고 system boot 시 enable되도록 해야한다.</li>
</ol>
<h3 id="configure-apache">Configure Apache</h3>
<p>다음 단계는 Apache가 Drupal과 잘 동작할 수 있도록 설정하는 것이다.
기본적으로 Ubuntu 12.04의 Apache는 mod_rewrite enabled가 되어있지 않다.
이를 해결하기 위해 우리는 <code>sudo a2enmod rewrite</code> 명령어를 입력해야 하지만 Ansible은 <code>apache2_module</code> module로 이를 간단하게 할 수 있다.</p>
<p>추가적으로 VirtualHost entry를 추가하여 Apache에게 사이트 문서의 root가 어딘지 알려주고 사이트의 다른 옵션들을 알려주어야 한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  - name: Enable Apache rewrite module (required for Drupal).
    apache2_module: name=rewrite state=present
    notify: restart apache

  - name: Add Apache virtualhost for Drupal <span style="color:#ae81ff">8</span> development
    template:
      src: <span style="color:#e6db74">&#34;templates/drupal.dev.conf.j2&#34;</span>
      dest: <span style="color:#e6db74">&#34;/etc/apache2/sites-available/{{ domain }}.dev.conf&#34;</span>
      owner: root
      group: root
      mode: <span style="color:#ae81ff">0644</span>
    notify: restart apache

  - name: Symlink Drupal virtualhost to sites-enabled.
    file:
      src: <span style="color:#e6db74">&#34;/etc/apache2/sites-available/{{ domain }}.dev.conf&#34;</span>
      dest: <span style="color:#e6db74">&#34;/etc/apache2/sites-enabled/{{ domain }}.dev.conf&#34;</span>
      state: link
    notify: restart apache

  - name: Remove default virtualhost file.
    file:
      path: <span style="color:#e6db74">&#34;/etc/apache2/sites-enabled/000-default&#34;</span>
      state: absent
    notify: restart apache
</code></pre></div><p>첫번째 명령어는 모든 필요한 Apache module들을 <code>/etc/apache2/mods-available</code>에서 <code>/etc/apache2/mods-enabled</code>로 symlink를 걸어 enable하는 것이다.</p>
<p>두번째 명령어는 우리가 templates 폴더 안에서 정의한 Jinja2 template을 Apache의 <code>sites-available</code> 폴더로 올바른 owner와 permission을 가지고 복사하는 것이다.
추가적으로 새로운 VirtualHost로 복사하는 것은 Apache가 변경사항을 가져오기 위해 재시작되어야 한다는 뜻이므로 <code>restart apache</code> handler에게 <code>notify</code>를 한다.</p>
<p>Jinja2 template(filename 마지막에 <code>.j2</code>라고 적혀있다)인 <code>drupal.dev.conf.j2</code>를 확인해보자.</p>
<pre><code class="language-j2" data-lang="j2">&lt;VirtualHost *:80&gt;
  ServerAdmin webmaster@localhost
  ServerName {{ domain }}.dev
  ServerAlias www.{{ domain }}.dev
  DocumentRoot {{ drupal_core_path }}
  &lt;Directory &quot;{{ drupal_core_path }}&quot;&gt;
    Options FollowSymLinks Indexes
    AllowOverride All
  &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</code></pre><p>이는 Apache VirtualHost definition의 거의 표준 형식이지만 우리는 거기에 Jinja2 template 변수들을 섞어넣었다.
Jinja2 template에서의 변수를 프린트하는 문법은 Ansible playbook의 문법과 동일하다. - 두개의 bracket(<code>{</code>)으로 변수의 이름을 감싼다. (<code>{{ varialbe }}</code>)</p>
<p>우리는 세가지 variable(<code>drupal_core_version</code>, <code>drupal_core_path</code>, <code>domain</code>)이 필요하여 이들을 전에 생성했던 <code>vars.yml</code> 파일에 추가해 주었다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># The core version you want to use (e.g. 6.x, 7.x, 8.0.x).</span>
drupal_core_version: <span style="color:#e6db74">&#34;8.0.x&#34;</span>

<span style="color:#75715e"># The path where Drupal will be downloaded and installed.</span>
drupal_core_path: <span style="color:#e6db74">&#34;/var/www/drupal-{{ drupal_core_version }}-dev&#34;</span>

<span style="color:#75715e"># The resulting domain will be [domain].dev (with .dev appended).</span>
domain: <span style="color:#e6db74">&#34;drupaltest&#34;</span>
</code></pre></div><p>이제 Ansible이 이 template을 위치시키게 될 play에 도달했을 때 Jinja2 template은 variable name을 value <code>8.0.x</code>와 <code>drupaltest</code>(또는 원하는 어떤 value)로 치환할 것이다.</p>
<p>마지막 두 task는(line 12-19) 방금 생성한 VirtualHost를 enable하고 더이상 사용하지 않는 default VirtualHost definition을 삭제할 것이다.</p>
<p>여기서부터 우리는 서버를 시작할 수 있지만 Apache는 우리가 정의한 VirtualHost가 아직 존재하지 않기 때문에(<code>{{ drupal_core_path }}</code>에 디렉토리가 아직 없다) 에러를 던질 것이다.
이는 <code>notify</code>를 사용하는 것이 중요한 이유이다. - 이 세 step이 끝나고 Apache를 재시작하기 위해 play를 추가하는 대신에(처음 playbook을 실행할 때는 에러가 발생할 것이다) notify는 task의 main group의 다른 모든 단계가 끝날때까지 기다린 뒤(server 세팅이 끝나기까지 시간을 준다) Apache를 재시작한다.</p>
<h3 id="configure-php-with-lineinfile">Configure PHP with lineinfile</h3>
<p>file management와 ad-hoc task execution에 관해 설명할 때 우리는 book에서의 <code>lineinfile</code>에 대해 짧게 언급했었다.
PHP의 configuration을 수정하는 것은 <code>lineinfile</code>의 simplicity와 usefulness를 설명하기에 매우 좋은 방법이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  - name: Enable upload progress via APC.
    lineinfile:
      dest: <span style="color:#e6db74">&#34;/etc/php5/apache2/conf.d/20-apcu.ini&#34;</span>
      regexp: <span style="color:#e6db74">&#34;^apc.rfc1867&#34;</span>
      line: <span style="color:#e6db74">&#34;apc.rfc1867 = 1&#34;</span>
      state: present
    notify: restart apache
</code></pre></div><p>Ansible의 <code>lineinfile</code> module은 간단한 task를 한다.
특정 text line이 파일에서 존재하는지(또는 존재하지 않는지) 확인한다.</p>
<p>이 예시에서 우리는 APC의 <code>rfc1867</code> option을 enable하여 Drupal이 APC의 파일 업로드 progress tracking을 사용하고 싶다.
(이걸 할수 있는 더 좋은 방법들이 있지만 우리의 간단한 서버를 위해선 이걸로도 충분하다)</p>
<p>먼저 <code>dest</code> parameter를 통해 <code>lineinfile</code>에게 파일의 위치를 알려주어야 한다.
그 다음 regular expression(Python-style)로 line이 어떻게 되어야 하는지를 정의한다.
(이 경우 line은 <code>apc.rfc1867</code>로 시작해야 한다. - 우리는 period를 escape해야 하는데 이는 regular expression에서 special character이기 때문이다)
그 다음 <code>lineinfile</code>에게 정확히 어떻게 resulting line이 되어야 하는지를 알려준다.
마지막으로 이 line이 present해야 한다고 명시적으로 언급한다.
(<code>state</code> parameter를 통해)</p>
<p>Ansible은 regular expression을 가지고 매칭되는 line이 있는지 본다.
있다면 Ansible은 line이 <code>line</code> parameter와 매칭되는지 확인한다.
매칭되지 않는다면 Ansible은 <code>line</code> parameter에 정의된 line을 추가한다.
Ansible은 추가하거나 line을 match <code>line</code>으로 변경해야하는 상황에서만 변경점을 report한다.</p>
<h3 id="configure-mysql">Configure MySQL</h3>
<p>다음 단계는 MySQL의 default test database를 삭제하고 Drupal installation에 사용할 (이전에 정의한 domain의 이름을 가진)database를 생성하는 것이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  - name: Remove the MySQL test database.
    mysql_db: db=test state=absent
  
  - name: Create a database for Drupal.
    mysql_db: <span style="color:#e6db74">&#34;db={{ domain }} state=present&#34;</span>
</code></pre></div><p>MySQL은 default로 <code>test</code>라 이름지어진 database를 설치하고 MySQL에 포함된 <code>mysql_secure_installation</code>의 일부 데이터베이스를 삭제하는 것을 권장한다.
MySQL을 configure하는 첫 단계는 이 database를 삭제하는 것이다.
그 다음 우리는 database를 <code>{{ domain }}</code>이란 이름으로 생성할 것이다 - database는 우리가 Drupal site에 사용할 domain가 동일하다.</p>
<div class="notices note" ><p>Ansible은 많은 데이터베이스를 <code>out-of-the-box</code>로 제공하여 기본으로 이용할 수 있다.
(이 글을 작성하는 시점에는 <code>MongoDB</code>, <code>MySQL</code>, <code>PostgreSQL</code>, <code>Redis</code>, <code>Riak</code>가 있다)
MySQL의 경우 Ansible은 MySQLdb Python package(python-mysqldb)를 사용하여 database server의 connection을 관리하고 default root 계정 credentials를 사용한다고 가정한다.
(<code>root</code>가 username이고 passowrd는 없다)
이런 default를 그대로 두는 것은 명백히 잘못된 생각이다.
production server에서 첫번째 단계중 하나는 root account의 password를 바꾸고 root account를 localhost로만 제한하고 불필요한 user를 제거하는 것이어야 한다.<br>
만약 다른 credentials를 사용한다면 Ansible이 MySQL에 접속할 때 Ansible playbook이나 variable files에 password를 기록하는 방법이 아닌 접속시 사용할 <code>.my.cnf</code> 파일을 remote user의 home directory에 추가할 수 있다.
아니면 Ansible playbook을 실행할 때 MySQL의 username과 password를 입력하게 할 수 있다.
prompts를 사용하는 이 옵션은 이 책의 뒷부분에서 다룰 것이다.</p>
</div>
<h3 id="install-composer-and-drush">Install Composer and Drush</h3>
<p>Drupal은 Drush의 형태로 commandl-line을 가지고 있다.
Drush는 Drupal과는 별개로 개발되고 있고 Drupal을 관리할 때 사용할 수 있는 CLI 명령어를 모두 제공한다.
Drush는 대부분의 현대 PHP 툴처럼 Composer의 dependency들을 설명해주는 파일인 <code>composer.json</code> 파일로 정의된 external dependency들이 있다.</p>
<p>여기서 우리는 단순히 Drupal을 다운로드하고 브라우저상으로 몇몇 setup을 수행하지만, playbook의 목적은 fully-automated가 되는 것이고, Drupal installation의 idempotent 속성을 부여하는 것이다.
따라서 우리는 Composer를 설치하고나서 Drush를 설치할 것이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  - name: Install Composer into the current directory.
    shell: <span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">     </span><span style="color:#e6db74"> </span><span style="color:#e6db74">curl -sS https://getcomposer.org/installer | php</span>
      creates=/usr/local/bin/composer
  
  - name: Move Composer into globally-accessible location.
    shell: <span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">     </span><span style="color:#e6db74"> </span><span style="color:#e6db74">mv composer.phar /usr/local/bin/composer</span>
      creates=/usr/local/bin/composer
</code></pre></div><p>첫번째 명령어는 <code>composer.phar</code> PHP application archive를 생성하는 Composer의 php-based installer를 실행시킨다.
이 archive는 (shell command에서는 <code>mv</code>를 이용하여) <code>/usr/local/bin/compsoer</code>로 복사되고 이를 통해 간단히 <code>composer</code> 명령어만 사용하여 Drush의 dependency들을 설치할 수 있다.
각 명령어는 <code>/usr/local/bin/composer</code> 파일이 존재하지 않을 때에만 동작하도록 설정되어있다(<code>creates</code> parameter를 통해).</p>
<div class="notices notes" ><p>왜 <code>command</code> 대신에 <code>shell</code>을 사용하는가?
Ansible의 <code>command</code> module은 host에서 명령을 실행할 때 많이 사용하는 option이다(Ansible의 module이 충분하지 않을 때).
그리고 이는 대부분의 시나리오에서 작동한다.
하지만 <code>command</code>는 remote shell <code>/bin/sh</code>를 통해 command를 실행할 수 없고 따라서 <code>&lt;</code>, <code>&gt;</code>, <code>|</code>, <code>&amp;</code>같은 옵션과 <code>$HOME</code>같은 local environment variables가 작동하지 않는다.
<code>shell</code>은 command의 ouput을 다른 command로 pipe를 연결해주고 local environment에 접속할 수도 있다.<br>
remote로 shell command를 실행시키는 것을 도와주는 module은 두가지가 더 있다.
<code>script</code>는 shell scripts(하지만 shell script를 idempotent한 Ansible playbook로 바꾸는 것이 무조건 좋다)를 실행하고, <code>raw</code>는 raw commands를 SSH(다른 옵션을 사용하지 못할때만 사용해야한다)를 통해 실행한다.<br>
Ansible module을 모든 task에 사용하는 것이 가장 좋다.
만약 regular command line command를 사용해야만 한다면 <code>command</code> module을 먼저 시도해 보아라.
위에서 언급한 option들을 필요로 한다면 <code>shell</code>을 사용해라.
<code>script</code>나 <code>raw</code>는 최대한 사용하지 말아야 하고 이 책에서는 다루지 않을 것이다.</p>
</div>
<p>이제 GitHub를 사용하여 가장 최근 버전의 Drush를 install할 것이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  - name: Check out drush master branch
    git:
      repo: https://github.com/drush-ops/drush.git
      dest: /opt/drush
  
  - name: Install Drush dependencies with Composer.
    shell: <span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">     </span><span style="color:#e6db74"> </span><span style="color:#e6db74">/usr/local/bin/composer install</span>
      chdir=/opt/drush
      creates=/opt/drush/vendor/autoload.php

  - name: Create drush bin symlink.
    file:
      src: /opt/drush/drush
      dest: /usr/local/bin/drush
      state: link
</code></pre></div><p>이 책의 앞부분에서 우리는 ad-hoc command를 통해 git repository를 clone하였다.
이번에는 <code>git</code> module을 사용하는 play를 정의하고 이를 통해 GitHub의 repository URL을 가지고 Drush를 clone할 것이다.
우리는 master branch를 사용할 것이기 때문에 <code>repo</code>(repository URL)과 <code>dest</code>(destination path) parameter를 넣어주어야 한다.</p>
<p>drush가 <code>/opt/drush</code>로 다운로드되고 나면, Composer를 사용하여 모든 필요한 dependency들을 설치한다.
이 경우 우리는 Ansible이 <code>composer install</code>를 <code>/opt/drush</code> 폴더에서 실행하길 원하고(이는 Composer가 자동으로 drush의 <code>composer.json</code> 파일을 검색하여 그렇게 된다) 따라서 우리는 parameter로 <code>chdir=/opt/drush</code>를 전달해주어야 한다.
Composer가 끝나고 나면 <code>/opt/drush/vendor/autoload.php</code>는 생성될 것이고 <code>creates</code> 파라미터를 사용하여 Ansible에게 파일이 이미 존재할 경우 이 단계를 건너뛰게 할 것이다(idempotency를 위해).</p>
<p>최종적으로 우리는 <code>/usr/local/bin/drush</code>에서 <code>/opt/drush/drush</code>로 symlink를 걸어주어 <code>drush</code> command가 시스템의 어느곳에서든지 실행할 수 있도록 하였다.</p>
<h3 id="install-drupal-with-git-and-drush">Install Drupal with Git and Drush</h3>
<p>우리는 다시 <code>git</code>을 사용하여 Drupal을 이전에 virtualhost configuration에서 정의한 대로 apache document root로 clone할 것이다.
그러고나서 Drupal의 installation을 drush를 통해 하고 다른 파일 permission issue들을 수정하여 Drupal이 VM에서 제대로 load되도록 설정할 것이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  - name: Check out Drupal Core to the Apache docroot.
    git:
      repo: http://git.drupal.org/project/drupal.git
      version: <span style="color:#e6db74">&#34;{{ drupal_core_version }}&#34;</span>
      dest: <span style="color:#e6db74">&#34;{{ drupal_core_path }}&#34;</span>
  
  - name: Install Drupal.
    command: <span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">     </span><span style="color:#e6db74"> </span><span style="color:#e6db74">drush si -y --site-name=&#34;{{ drupal_site_name }}&#34; --acount-name=admin</span>
      --account-pass=admin --db-url=mysql://root@localhost/{{ domain }}
      chdir={{ drupal_core_path }}
      creates={{ drupal_core_path }}/sites/default/settings.php
    notify: restart apache

  <span style="color:#75715e"># SEE: https://drupal.org/node/2121849#comment-8413637</span>
  - name: Set permissions properly on settings.php.
    file:
      path: <span style="color:#e6db74">&#34;{{ drupal_core_path }}/sites/default/settings.php&#34;</span>
      mode: <span style="color:#ae81ff">0744</span>

  - name: Set permissions on files directory.
    file:
      path: <span style="color:#e6db74">&#34;{{ drupal_core_path }}/sites/default/files&#34;</span>
      mode: <span style="color:#ae81ff">0777</span>
      state: directory
      recurse: yes
</code></pre></div><p>먼저 우리는 <code>vars.yml</code>파일 안에 정의된 <code>drupal_core_version</code>값으로 <code>version</code>을 지정하여 Drupal의 git repository를 clone할 것이다.
<code>git</code> module의 <code>version</code> parameter는 branch(<code>master</code>, <code>8.0.x</code> 등)와 tag(<code>1.0.1</code>, <code>7.24</code> 등) 또는 개별 commit hash(<code>50a1877</code> 등)를 지정하여 clone할 수 있다.</p>
<p>그 다음 Drush의 <code>si</code> 명령어(<code>site-install</code>의 줄임말)는 사용하여 Drupal의 installation(database를 configure하고, 몇가지 maintenance를 실행하고, site를 위한 몇몇 default configuration setting을 설정한다)을 실행할 것이다.
<code>drupal_core_version</code>과 <code>domain</code>같은 몇가지 variable들을 전달한다.
또한 <code>drupal_site_name</code>을 추가하여 varaible을 <code>vars.yml</code> 파일에 추가한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># Your Drupal site name.</span>
drupal_site_name: <span style="color:#e6db74">&#34;D8 Test&#34;</span>
</code></pre></div><p>또한, Drupal의 installation process는 결과적으로 <code>settings.php</code> 파일을 생성한다.
따라서 우리는 해당 파일의 location을 <code>creates</code> parameter를 통해 Ansible이 site가 이미 설치되었는지를 판단하도록 할 수 있다(따라서 실수로 재설치하지 않는다).
site가 install되고 나면, Apache도 재시작할 것이다.
(Apache의 configuration을 업데이트할 때 사용했던 것처럼 <code>notify</code>를 다시 사용할 것이다.)</p>
<p>마지막 두 task는 Drupal의 <code>settings.php</code>와 폴더들의 permission을 각각 <code>744</code>와 <code>777</code>로 설정하는 것이다.</p>
<h3 id="drupal-lamp-server-summary">Drupal LAMP server summary</h3>
<p>이제 <code>http://drupaltest.dev/</code>로 서버에 접속하게 되면(<code>drupaltest.dev</code>가 VM의 IP주소를 가르킨다고 가정한다) Drupal의 default home page를 볼 수 있고 <code>admin/admin</code>으로 접속이 가능하다.
(production server에서는 명백히 안전한 password를 설정해야 한다)</p>
<p>Apache, MySQL, PHP를 실행하는 비슷한 server configuration으로 Drupal뿐 아니라 Symfony, Wordpress, Joomla, Laravel 등과 같은 다른 web frameworks와 CMS들을 실행할 수 있다.</p>
<div class="notices notes" ><p>전체 Drupal LAMP server playbook의 예시는 책의 code repository인 <a href="https://github.com/geerlingguy/ansible-for-devops">https://github.com/geerlingguy/ansible-for-devops</a>의 <code>drupal</code> directory에서 확인할 수 있다.</p>
</div>
<h2 id="real-world-playbook-ubuntu-apache-tomcat-server-with-solr">Real-world playbook: Ubuntu Apache Tomcat server with Solr</h2>
<p>Apache Solr는 full-text search, word highlighting, faceted search, fast indexing 등에 optimize된 빠르고 scalable한 search server이다.
매우 유명한 search server로 Ansible을 통해 설치하고 설정하기가 꽤 쉽다.
다음의 example에서 우리는 Apache Solr를 Ubuntu 12.04와 Apache Tomcat을 통해 설정할 것이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">+-----------------------------------+
|                                   |
|       Apache Solr Server/VM       |
|                                   |
+-----------------------------------+
|                                   |
| +-------------------------------+ |
| |                               | |
| |        Apache Solr 4.x        | |
| |                               | |
| +-------------------------------+ |
|                                   |
| +-------------------------------+ |
| |                               | |
| |        Apache Tomcat 7        | |
| |                               | |
| +-------------------------------+ |
|                                   |
| +-------------------------------+ |
| |                               | |
| |      Ubuntu 12.04 (Linux)     | |
| |                               | |
| +-------------------------------+ |
|                                   |
+-----------------------------------+
</code></pre></div><p><strong>Apache Solr Server.</strong></p>
<h3 id="include-a-variables-file-and-discover-pre_tasks-and-handlers-1">Include a variables file, and discover <code>pre_tasks</code> and <code>handlers</code></h3>
<p>이전의 LAMP server 예시처럼 우리는 분리된 <code>vars.yml</code> 파일에 있는 variable들을 Ansible에게 알려주는 것으로부터 playbook을 시작한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- hosts: all
  
  vars_files:
  - vars.yml
</code></pre></div><p><code>vars.yaml</code>에 대해 생각해보는 동안 빠르게 <code>vars.yaml</code> 파일을 생성하자.
Solr playbook과 동일한 폴더에 파일을 생성하고 다음의 내용을 추가하자.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">download_dir: /tmp
solr_dir: /opt/solr
</code></pre></div><p>이 두 변수는 Apache Solr를 다운로드하고 설치하는 동안 사용할 path를 정의한 것이다.</p>
<p><code>vars_files</code>를 마치고 playbook으로 돌아와서 우리는 <code>pre_tasks</code>를 사용하여 apt cache가 업데이트되도록 할 것이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  pre_tasks:
  - name: Update apt cache if needed.
    apt: update_cache=yes cache_valid_time=<span style="color:#ae81ff">3600</span>
</code></pre></div><p>Drupal playbook처럼 우리는 다시 <code>handlers</code>를 사용하여 <code>tasks</code> section에서 notify를 받는 특정한 tasks를 정의할 것이다.
이번에는 handler를 사용하여 Apache Solr에 영향을 주는 <code>tomcat7</code>과 Java servlet container를 재시작할 것이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  handlers:
  - name: restart tomcat
    service: name=tomcat7 state=restarted
</code></pre></div><p>우리는 playbook 안에서 handler를 <code>notify: restart tomcat</code> 옵션을 통해 호출할 것이다.</p>
<h3 id="install-apache-tomcat-7">Install Apache Tomcat 7</h3>
<p>Ubunntu 특정 서버에서 Tomcat7을 설치하는 것은 쉽다.
apt repository에 package가 있기 때문에 우리는 이것이 설치 되었는지, <code>tomcat7</code> service가 enabled 되었고 start 되었는지만 확인하면 된다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  tasks:
  - name: Install Tomcat <span style="color:#ae81ff">7</span>.
    apt: <span style="color:#e6db74">&#34;name={{ item }} state=installed&#34;</span>
    with_items:
      - tomcat7
      - tomcat7-admin
      <span style="color:#e6db74">- 
</span><span style="color:#e6db74"> </span><span style="color:#e6db74"> </span><span style="color:#e6db74">- name: Ensure Tomcat 7 is started and enabled on boot.</span>
    service: name=tomcat7 state=started enabled=yes
</code></pre></div><p>엄청 쉽다.
우리는 <code>apt</code> module을 이용하여 <code>tomcat7</code>과 <code>tomcat7-admin</code> 두 package를 설치하였다(그래서 우리는 Tomcat의 administrative backend에 로그인할 수 있다).
그리고 <code>tomcat7</code>을 시작하고 system boot할 때 start 되도록 설정한다.</p>
<h3 id="install-apache-solr">Install Apache Solr</h3>
<p>Ubuntu 12.04는 Apache Solr에 대한 package를 포함한다.
하지만 매우 오래된 버전을 설치하기 때문에 우리는 source로부터 Solr의 최신 버전을 설치할 것이다.
첫번째 단계는 source를 다운로드하는 것이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  - name: Download Solr.
    get_url:
      url: http://apache.osuosl.org/lucene/solr/<span style="color:#ae81ff">4.9</span><span style="color:#ae81ff">.1</span>/solr<span style="color:#ae81ff">-4.9</span><span style="color:#ae81ff">.1</span>.tgz
      dest: <span style="color:#e6db74">&#34;{{ download_dir }}/solr-4.9.1.tgz&#34;</span>
      sha256sum: 4a546369a31d34b15bc4b99188984716bf4c0c158c0e337f3c1f98088aec70ee
</code></pre></div><p>우리는 가장 최근의 stable 버전인 Apache Solr 4.9.1을 설치한다.
remote server에서 파일을 다운로드 했을 때 <code>get_url</code> module은 raw <code>wget</code>이나 <code>curl</code> 명령어보다 더 유연함과 편리함을 제공한다.</p>
<p><code>get_url</code>에 <code>url</code>(파일 소스를 다운로드할 주소)과 <code>dest</code>(다운로드된 파일이 위치할 곳)를 전달해 주어야 한다.
<code>dest</code> parameter로 디렉토리를 넘기면 Ansible은 파일을 안에다가 위치시키지만 나중에 playbook이 실행될 때마다 다시 다운로드할 것이다(만약 변경사항이 있다면 기존의 것은 overwrite된다).
이런 overhead를 피하기 위해 우리는 다운로드할 파일의 full path를 입력한다.</p>
<p>우리는 안정성을 위해 optional parameter인 또한 <code>sha256sum</code>을 사용한다.
파일이나 archive를 다운로드 하면 application의 functionality와 security의 취약점이 되기 때문에 file이 우리가 생각하는 것과 동일한지 확인하는 것은 좋은 생각이다.
<code>sha256sum</code>은 다운로드된 파일에서 data의 hash와 지정한 256-bit hash(<code>shasum -a 256 /path/to/file</code>을 통해 파일의 <code>sha256sum</code>을 얻을 수 있다)를 비교한다.
checksum이 제공한 hash와 일치하지 않으면 Ansible은 fail될 것이고 새로워진(그리고 유효하지 않는) 다운로드 파일을 버릴 것이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  - name: Expand Solr.
    command: <span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">     </span><span style="color:#e6db74"> </span><span style="color:#e6db74">tar -C /tmp -xvzf {{ download_dir }}/solr-4.9.1.tgz</span>
      creates={{ download_dir }}/solr<span style="color:#ae81ff">-4.9</span><span style="color:#ae81ff">.1</span>/dist/solr<span style="color:#ae81ff">-4.9</span><span style="color:#ae81ff">.1</span>.war

  - name: Copy Solr into place.
    command: <span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">     </span><span style="color:#e6db74"> </span><span style="color:#e6db74">cp -r {{ download_dir }}/solr-4.9.1 {{ solr_dir }}</span>
      creates={{ solr_dir }}/dist/solr<span style="color:#ae81ff">-4.9</span><span style="color:#ae81ff">.1</span>.war
</code></pre></div><p>우리는 Apache Solr archive를 압축해제하고 위치로 복사해야 한다.
이 두 단계를 위해 내장된 <code>tar</code>과 <code>cp</code> utility를 (적절한 옵션을 가지고) 사용한다.
<code>creates</code>를 설정하는 것은 Ansible이 나중에 다시 실행되었을 때 Solr war file이 이미 존재하기 때문에 이 단계를 건너 뛰게 한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  <span style="color:#75715e"># Use shell so commands are passed in correctly.</span>
  - name: Copy Solr components into place.
    shell: <span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">     </span><span style="color:#e6db74"> </span><span style="color:#e6db74">cp -r {{ item.src }} {{ item.dest }}</span>
      creates={{ item.creates }}
    with_items:
      <span style="color:#75715e"># Solr example configuration and war file.</span>
      - {
        src: <span style="color:#e6db74">&#34;{{ solr_dir }}/example/webapps/solr.war&#34;</span>,
        dest: <span style="color:#e6db74">&#34;{{ solr_dir }}/solr.war&#34;</span>,
        creates: <span style="color:#e6db74">&#34;{{ solr_dir }}/solr.war&#34;</span>
      }
      - {
        src: <span style="color:#e6db74">&#34;{{ solr_dir }}/example/solr/*&#34;</span>,
        dest: <span style="color:#e6db74">&#34;{{ solr_dir }}/&#34;</span>,
        creates: <span style="color:#e6db74">&#34;{{ solr_dir }}/solr.xml&#34;</span>
      }
      <span style="color:#75715e"># Solr log4j logging configuration</span>
      - {
        src: <span style="color:#e6db74">&#34;{{ solr_dir }}/example/lib/ext/*&#34;</span>,
        dest: <span style="color:#e6db74">&#34;/var/lib/tomcat7/shared/&#34;</span>,
        creates: <span style="color:#e6db74">&#34;/var/lib/tomcat7/shared/log4j-1.2.16.jar&#34;</span>
      }
      - {
        src: <span style="color:#e6db74">&#34;{{ solr_dir }}/example/resources/log4j.properties&#34;</span>,
        dest: <span style="color:#e6db74">&#34;/var/lib/tomcat7/shared/classes&#34;</span>,
        creates: <span style="color:#e6db74">&#34;/var/lib/tomcat7/shared/classes/log4j.properties&#34;</span>
      }
    notify: restart tomcat
</code></pre></div><p>다음 task는 Apache Solr를 실행하는데 필요한 특정 디렉토리와 파일을 복사하는 단계이다.</p>
<p>여기서는 특별한게 없지만 이 예시는 <code>with_items</code> lists안에서 comment를 사용하여 list안의 item들을 명시해주는 것을 보여준다.
우리는 각 command들을 각각 따로 task로 만들 수 있지만 이렇게 한 이유는 총 Ansible task의 수를 줄여주고 <code>with_items</code> list를 필요시 external variable로 옮기기 위한 것이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  - name: Ensure solr example directory is absent.
    file: 
      path: <span style="color:#e6db74">&#34;{{ solr_dir }}/example&#34;</span>
      state: absent

  - name: Set up solr data directory
    file:
      path: <span style="color:#e6db74">&#34;{{ solr_dir }}/data&#34;</span>
      state: directory
      owner: tomcat7
      group: tomcat7
</code></pre></div><p>최신 버전의 Apache Solr는 <code>{{ solr_dir }}</code> 폴더 내부를 모두 resursive하게 검색하여 potential search configuration을 로딩한다.
우리는 서버의 default search core를 사용하기 위해 example 중 하나를 복사하였기 때문에 Solr는 그 examplㄷ과 duplicate라고 알게되고 crash가 날 것이다.
따라서 우리는 <code>file</code> module에 <code>path</code>를 사용하여 example directory가 없도록 할 것이다(<code>state=absent</code>).</p>
<p>example directory를 지우고 나서(다음에 실행할 때에도 없어져 있어야 한다) 우리는 Solr가 index data를 저장할 data directory가 존재하고 <code>tomcat7</code> user와 group으로 owner를 설정되도록 해야한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  - name: Configure solrconfig.xml for new data directory.
    lineinfile:
      dest: <span style="color:#e6db74">&#34;{{ solr_dir }}/collection1/conf/solrconfig.xml&#34;</span>
      regexp: <span style="color:#e6db74">&#34;^.*&lt;dataDir.+%&#34;</span>
      line: <span style="color:#e6db74">&#34;&lt;dataDir&gt;${solr.data.dir:{{ solr_dir }}/data}&lt;/dataDir&gt;&#34;</span>
      state: present
</code></pre></div><p>앞에서 보았듯이 <code>lineinfile</code>은 idempotent하게 configuration file setting이 존재하는지 확인하는 데 유용한 module이다.
이 경우에 우리는 <code>&lt;dataDir&gt;</code> 줄이 우리 default search core의 configuration에 특정한 값으로 설정되어있는지 확인해야한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  - name: Set permissions for solr home.
    file:
      path: <span style="color:#e6db74">&#34;{{ solr_dir }}&#34;</span>
      recurse: yes
      owner: tomcat7
      group: tomcat7
</code></pre></div><p><code>{{ solr_dir }}</code>의 전체 content에서 ownership option을 알맞게 설정하기 위해 우리는 <code>file</code> module을 <code>recurse</code> parameter를 <code>yes</code>로 설정하여 사용할 것이다.
이는 shell command에서의 <code>chown -R tomcat7:tomcat7 {{ solr_dir }}</code>과 동일하다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  - name: Add Catalina configuration for solr.
    template:
      src: templates/solr.xml.j2
      dest: /etc/tomcat7/Catalina/localhost/solr.xml
      owner: root
      group: tomcat7
      mode: <span style="color:#ae81ff">0644</span>
    notify: restart tomcat
</code></pre></div><p>마지막 task는 template file (<code>solr.xml.j2</code>)를 remote host로 복사하고 Jinja2 문법으로 variable들을 대체한 뒤 file의 ownership과 permission을 Tomcat에 필요한 것으로 설정한다.</p>
<p>task가 실행되기 전에 local template file은 생성이 되어있어야 한다.
<code>templates</code> 폴더를 Apache Solr playbook의 디렉토리와 같은 곳에서 생성하고 다음의 내용으로 <code>solr.xml.j2</code>를 그 안에 생성한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">&lt;?xml version=<span style="color:#e6db74">&#34;1.0&#34;</span> encoding=<span style="color:#e6db74">&#34;utf-8&#34;</span>?&gt;
&lt;Context docBase=<span style="color:#e6db74">&#34;{{ solr_dir }}/solr.war&#34;</span> debug=<span style="color:#e6db74">&#34;0&#34;</span> crossContext=<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#e6db74">&gt;
</span><span style="color:#e6db74"> </span><span style="color:#e6db74"> </span><span style="color:#e6db74">&lt;Environment name=&#34;solr/home&#34; type=&#34;java.lang.String&#34; value=&#34;{{ solr_dir }}&#34; override=&#34;true&#34;/&gt;</span>
&lt;/Context&gt;
</code></pre></div><p>playbook을 <code>$ ansible-playbook [playbook-name.yml]</code>로 실행하고 몇분 후에(서버의 인터넷 환경에 따라 다르다) Solr admin interface로 <code>http://example.com:8080/solr</code>를 통해 접속할 수 있다(<code>example.com</code>이 우리 서버의 hostname이나 IP 주소로 바뀌어야 한다).</p>
<h3 id="apache-solr-server-summary">Apache Solr server summary</h3>
<p>Apache Solr를 deploy할 때 사용했던 configuration은 multicore setup을 할 수 있고 따라서 우리는 admin interface를 통해 &lsquo;search cores'를 추가할 수 있다(디렉토리와 core schema configuration이 filesystem에 위치시킨다).
그리고 multiple website와 application을 위한 multiple indexes를 가질 수 있다.</p>
<p>위에서 보앗던 것과 유사한 playbook은 Drupal website에 대한 Apache Solr search core를 hosts하는 service인 infrastructure for Hosted Apache Solr의 일부로 사용되었다.</p>
<div class="notices notes" ><p>전체 Apache Solr server playbook에 대한 예제는 이 책의 code repository인 <a href="https://github.com/geerlingguy/ansible-for-devops">https://github.com/geerlingguy/ansible-for-devops</a>의 <code>solr</code> directory에서 확인 가능하다.</p>
</div>
<h2 id="summary">Summary</h2>
<p>이제 우리는 Ansible의 <code>modus operandi</code>에 친숙해지게 되었다.
Playbook은 Ansible의 configuration management와 provisioning 기능의 심장이고 동일한 module과 비슷한 syntax로 ad-hoc command를 사용하여 일반 서버 management에 deployment를 할 수 있다.</p>
<p>이제 playbook에 친숙해졌으니 task의 organization, condition, variable과 같은 playbook을 만드는 좀 더 깊숙한 개념들에 대해 알아볼 것이다.
나중에 우리는 role을 통한 playbook의 사용법을 배워 이를 무한정으로 유연하고 infrastructure를 configure하고 setting하는 데 드는 시간을 줄일 것이다.</p>
</div>



<footer class=" footline" >
	
</footer>


        
        </div> 
        <div id="utterance">    
    <script src="https://utteranc.es/client.js"
            repo="kimmj/kimmj.github.io"
            issue-term="pathname"
            label="comments"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
</div>
      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1582894344"></script>
    <script src="/js/perfect-scrollbar.min.js?1582894344"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1582894344"></script>
    <script src="/js/jquery.sticky.js?1582894344"></script>
    <script src="/js/featherlight.min.js?1582894344"></script>
    <script src="/js/highlight.pack.js?1582894344"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1582894344"></script>
    <script src="/js/learn.js?1582894344"></script>
    <script src="/js/hugo-learn.js?1582894344"></script>

    <link href="/mermaid/mermaid.css?1582894344" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1582894344"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

